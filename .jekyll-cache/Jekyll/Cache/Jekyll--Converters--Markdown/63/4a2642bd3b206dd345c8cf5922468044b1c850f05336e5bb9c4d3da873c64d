I"Å*<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>review the use of Authentication using BCrypt</li>
  <li>review the use of ‚Äòroles‚Äô for permissions using enums</li>
  <li>review the use of sessions in Rails</li>
  <li>introducing cookies</li>
</ul>

<h2 id="authentication-vs-authorization">Authentication vs Authorization</h2>

<ul>
  <li>Authentication: who are you?</li>
  <li>Authorization: what are you allowed to do?</li>
</ul>

<h2 id="authentication-patterns">Authentication patterns</h2>

<p>Generally we want to avoid storing passwords for users, but if we must, we
should use a tool like <a href="https://github.com/codahale/bcrypt-ruby">BCrypt</a> to do a one-way encryption on the user‚Äôs password
so that it cannot be reversed back into ‚Äúplaintext‚Äù format.</p>

<p>If a user attempts to view a page and they have not authenticated, we will
typically return a 401 status code.</p>

<h3 id="implementing-a-login-page">Implementing a Login Page</h3>

<p>In Rails 5.x, we will typically build a login page using <code class="highlighter-rouge">form_tag</code>, which is
being replaced with <code class="highlighter-rouge">form_with</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="sx">%= form_with url: sessions_path, local: true do |form| %&gt;
  &lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:username</span> <span class="o">%&gt;</span>
  <span class="o">&lt;</span><span class="sx">%= form.text_field :username %&gt;

  &lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:password</span> <span class="o">%&gt;</span>
  <span class="o">&lt;</span><span class="sx">%= form.password_field :password %&gt;

  &lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="s1">'Log in'</span> <span class="o">%&gt;</span>
<span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</code></pre></div></div>

<p>(The <code class="highlighter-rouge">local: true</code> flag will stop our form from using JavaScript to send our
form as an AJAX call to our endpoint.)</p>

<p>We will continue to use ‚Äústrong parameters‚Äù to ensure we only permit certain
attributes to be sent with our form data.</p>

<h3 id="sessionscontroller">SessionsController</h3>

<p>Our sessions controller be responsible for looking up our user to determine
that they were previously registered. If that succeeds, we will will store a
hash of data into a cookie, which is also encrypted so it cannot be tampered
with. We should never expect that this encryption is fool-proof, and we should
not store anything sensitive about the user in the session other than their
user_id and other attributes which do not have any opportunity to compromise
our system.</p>

<h2 id="authorization-patterns">Authorization patterns</h2>

<p>Most modern web applications have different kinds of users. These users will
generally be allowed to do different things. In Mod2, we introduced the use of
an ‚Äúenum‚Äù type in ActiveRecord to store a simple integer representing our user‚Äôs
‚Äúrole‚Äù in a system. These roles might have included setting a 0 for ‚Äúanonymous‚Äù
user browsing our site, ‚Äú1‚Äù for ‚Äúregular user‚Äù who has registered, ‚Äú2‚Äù for a
‚Äúmerchant‚Äù and maybe ‚Äú3‚Äù for an ‚Äúadmin‚Äù user of some sort.</p>

<p>In more complex systems, permissions are handled on a more granular basis.
Perhaps a registered user has permission to do a few things on the site, but
maybe a user who pays a membership fee is allowed to do additional things.
Maybe a merchant user could be split into several roles: maybe one kind of
merchant user who can add/edit items for sale, but not allowed to access
invoice data. Another merchant could be in charge of our finances and needs to
see customer invoices, but shouldn‚Äôt have access to add additional items for
sale, etc..</p>

<p>In this case, a simple ‚Äúenum‚Äù isn‚Äôt enough, and we would need a more complex
‚Äúpermissions‚Äù system put in place.</p>

<h3 id="user-model">User Model</h3>

<p>We would generally store this ‚Äòrole‚Äô as an attribute on our User model, and
use this with our SessionsController to determine what the user is allowed to
do on our site.</p>

<p>The most basic form of authorization is a simple ‚Äúenum‚Äù data type, which is
stored as an integer in the database, but can be mapped to a string within our
application. The benefit of using the enum type is that Rails generates some
methods for us about the User model.</p>

<p>For example, if we define our enum like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/user.rb</span>

<span class="n">enum</span> <span class="ss">role: </span><span class="sx">%w(default admin)</span>
</code></pre></div></div>

<p>‚Ä¶ then Rails will make additional methods for us like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_username</span><span class="p">(</span><span class="s1">'marty'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="s1">'mcfly'</span><span class="p">)</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>
  <span class="n">redirect_to</span> <span class="n">admin_dashboard</span> <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">admin?</span>  <span class="c1"># &lt;-- check this out!!</span>
  <span class="n">redirect_to</span> <span class="n">user_dashboard</span> <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">default?</span>
<span class="k">else</span>
  <span class="n">flash</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Your credentials are bad, and you should feel bad."</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="applicationcontroller-and-helper-methods">ApplicationController and helper methods</h2>

<p>In our ApplicationController, where our other Controllers will inherit
properties and methods, we can make a helper method to use elsewhere in our
controllers and views (but not within models) to check whether we have a user
who has logged in or not, and from that, determine their role.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/application_controller.rb</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">helper_method</span> <span class="ss">:current_user</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, within any controller or view we can call <code class="highlighter-rouge">current_user</code>, and from there
determine whether the user has permission to do other things.</p>

<h2 id="mmm-cookies-">Mmm, cookies ‚Ä¶</h2>

<p>Hold up there, my snack-minded friend. Let‚Äôs talk a little more about cookies.
This is NEW CONTENT.</p>

<p>As discussed above, our session data is stored in a cookie, which is a small
file stored via the client‚Äôs browser, sent back and forth in our HTTP headers.</p>

<p>Cookies are generally limited to about 4kb of total content, and we can make our
own cookies.</p>

<p>Important to note: We must send a response to the user in order to set or update
a cookie. These cookies are generally deleted from your browser whenever you
fully close your browser.</p>

<p>In our controllers, we can utilize code like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cookies[:css_mode] = {
  'dark mode': true,
  expires: 30.days
}
</code></pre></div></div>

<p>This is a ‚Äúplain‚Äù cookie, but we‚Äôve set the value to expire after 30 days. A
user can go into their browser and see these cookie values in ‚Äúplaintext‚Äù, and
could potentially change them as well.</p>

<p>We can make ‚Äúsigned‚Äù cookies, which prevents users from tampering with the value
but still makes them viewable:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="ss">:read_only</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">settings: </span><span class="p">{</span>
    <span class="s1">'discount'</span><span class="p">:</span> <span class="s1">'10%'</span>
  <span class="p">},</span>
  <span class="ss">expires: </span><span class="mi">7</span><span class="p">.</span><span class="nf">days</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can also encrypt cookies so the user can‚Äôt even read them:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:super_secret</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">settings: </span><span class="p">{</span>
    <span class="s1">'last_coupon_code'</span><span class="p">:</span> <span class="s1">'abc123'</span>
  <span class="p">},</span>
  <span class="ss">expires: </span><span class="mi">7</span><span class="p">.</span><span class="nf">days</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can read more about cookies in <a href="https://api.rubyonrails.org/v5.2.4.3/classes/ActionDispatch/Cookies.html">the Rails documentation</a></p>
:ET