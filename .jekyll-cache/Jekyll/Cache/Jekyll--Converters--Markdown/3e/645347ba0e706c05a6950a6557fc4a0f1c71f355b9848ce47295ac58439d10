I"U<p><strong>Nota bene:</strong> This is the successor to <a href="https://github.com/turingschool/lesson_plans/blob/master/ruby_04-apis_and_scalability/pubsub_in_the_browser.markdown">the Pub/Sub in the Browser lesson</a>.</p>

<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Understand what it means for an application to be “real time.”</li>
  <li>Understand the pub/sub model</li>
  <li>Understand how WebSockets work</li>
  <li>Set up a basic Node.js server using Express</li>
  <li>Implement pub/sub in the browser using Socket.io</li>
</ul>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://github.com/turingschool-examples/right-now">right-now</a> repository  in <a href="https://github.com/turingschool-examples">turingschool-examples</a></li>
</ul>

<h2 id="structure">Structure</h2>

<ul>
  <li>5 - Warm up</li>
  <li>20 - Lecture</li>
  <li>5 - Break</li>
  <li>25 - Experiment  #1: Right Now</li>
  <li>5 - Break</li>
  <li>25 - Experiment #2: Twitter Stream</li>
  <li>5 - Wrap Up</li>
</ul>

<h2 id="warm-up">Warm Up</h2>

<p>In your notebook, record your answers to the following questions:</p>

<ul>
  <li>What does it mean to be <em>real time</em>?</li>
  <li>Can we name any applications that are <em>real time</em>?</li>
  <li>What’s stopping our applications from being real time?</li>
</ul>

<h2 id="lecture">Lecture</h2>

<ul>
  <li>Explain WebSockets vs. the HTTP request/response cycle
    <ul>
      <li>A WebSocket is a persistent two-way connection between the server and the client</li>
      <li>The server can push an event without having to receive a request from the client</li>
      <li>The client can send messages to the server without having to wait for a response</li>
    </ul>
  </li>
  <li>In what contexts would you want to consider WebSockets?
    <ul>
      <li>Chat/instant messaging</li>
      <li>Real-time analytics</li>
      <li>Document collaboration</li>
      <li>Streaming</li>
    </ul>
  </li>
  <li>WebSockets work best when there is an event-driven server on the backend
    <ul>
      <li>Ruby with <a href="http://rubyeventmachine.com/">EventMachine</a></li>
      <li><a href="http://nodejs.org">Node.js</a></li>
    </ul>
  </li>
  <li><a href="http://socket.io/">Socket.io</a> and <a href="http://faye.jcoglan.com/">Faye</a> will fallback to other methods if it can’t make a WebSocket connection
    <ul>
      <li>Some examples include: long-polling, Adobe Flash sockets</li>
    </ul>
  </li>
  <li>ActionCable</li>
</ul>

<h2 id="experiment-right-now">Experiment: Right Now</h2>

<h3 id="getting-started">Getting Started</h3>

<p><a href="https://github.com/turingschool-examples/right-now">This repository</a> contains a simple little Express app that servers a static <code class="highlighter-rouge">index.html</code> page. It also has <a href="http://socket.io/">Socket.io</a> hooked up by default—despite the fact that we’re not using it at this moment.</p>

<p>You can fire up the server with <code class="highlighter-rouge">npm start</code>.</p>

<p>Let’s start with a simple “hello world” implementation.</p>

<p>In our server, add the following code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// index.js</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Someone has connected.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>When a connection is made to via WebSocket, you’re server will log it to the console. The next step, of course is create a connection via WebSocket, right?</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// public/application.js</span>
<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">();</span>
</code></pre></div></div>

<p>You should see the following in your terminal after you refresh the page:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Your server is up and running on Port 3000. Good job!
Someone has connected.
</code></pre></div></div>

<p>We can also let the client celebrate our new connection.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// public/application.js</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connect</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">You have connected!</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>One thing that you’ve probably picked up on is that we have an <code class="highlighter-rouge">io</code> object on the server—as well as the client-side of our application.</p>

<p>So, let’s send a message over the wire when a user connects.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// index.js</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Someone has connected.</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">turingbot</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Hello, world!</span><span class="dl">'</span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Like everything with WebSockets, this is a two-part affair. The server is now emitting an event on the <code class="highlighter-rouge">message</code> channel. (This is arbitrary—like <code class="highlighter-rouge">sandwich_time</code> was when we discussed the using Redis for PubSub on the server-side.) We now need to do something when the client receives that message.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Something came along on the "message" channel:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Super cool. You did the thing! Let’s shoot some stuff over the wire on a regular interval.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// index.js</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">interval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">turingbot</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">I am a banana.</span><span class="dl">'</span><span class="p">});</span>
  <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">disconnect</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="your-turn">Your Turn</h3>

<p>So, right now, we’re pushing data from the client out to the server. That’s cool, but it would be nicer if we displayed them onto the page.</p>

<p>Can you write some jQuery to append these messages to the DOM?</p>

<h3 id="talking-back-to-the-server">Talking Back to the Server</h3>

<p>WebSockets are a two-way street. We can send something back to the server over <code class="highlighter-rouge">socket.send</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// public/application.js</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connect</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">You have connected!</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">yournamehere</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">I did the thing.</span><span class="dl">'</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Let’s also write a listener on the server.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// index.js</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">interval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">turingbot</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">I am a banana.</span><span class="dl">'</span><span class="p">});</span>
  <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">channel</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">disconnect</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p><strong>Important Note</strong>: We’re doing it like this to demonstrate how you would push information from the client to the server using WebSockets. But, keep in mind, that the client has always been able to send requests to the server. It’s totally okay to use AJAX in this situation.</p>

<h3 id="your-turn-1">Your Turn</h3>

<ul>
  <li>Write the functionality on the client that sends something over the <code class="highlighter-rouge">mission</code> channel.</li>
  <li>Write the functionality on the server that listens on the <code class="highlighter-rouge">mission</code> channel and logs it to the console.</li>
</ul>

<p>Here is a little bit of code to point you in the right direction.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="adding-some-nuance">Adding Some Nuance</h3>

<p>So far, we’ve had one server talking to one client. This has a lot of practical value, but what if we wanted to create add more functionality to our little application? Socket.io has a few other APIs for fine-tuning your application.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Send to current request socket client</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">turingbot</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You can do the thing.</span><span class="dl">'</span><span class="p">});</span>

<span class="c1">// Sending to all clients, include sender</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">turingbot</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You can do the thing.</span><span class="dl">'</span><span class="p">});</span>

<span class="c1">// Sending to all clients except sender</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">turingbot</span><span class="dl">'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You can do the thing.</span><span class="dl">'</span><span class="p">});</span>
</code></pre></div></div>

<p>You can also start to break your messaging out in additional channels. Here’s an example.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">new message</span><span class="dl">'</span><span class="p">,</span> <span class="nx">addMessageToPage</span><span class="p">);</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">new connection</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">updateStatus</span><span class="p">(</span><span class="dl">'</span><span class="s1">A new user has connected.</span><span class="dl">'</span><span class="p">);</span> <span class="p">});</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">lost connection</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">updateStatus</span><span class="p">(</span><span class="dl">'</span><span class="s1">Someone has disconnected.</span><span class="dl">'</span><span class="p">);</span> <span class="p">});</span>
</code></pre></div></div>

<p>There are also some helpful methods for seeing how many clients are currently connected.</p>

<ul>
  <li><code class="highlighter-rouge">io.engine.clientsCount</code></li>
  <li><code class="highlighter-rouge">io.sockets.sockets.length</code></li>
  <li><code class="highlighter-rouge">Object.keys(io.sockets.connected).length</code></li>
</ul>

<h3 id="your-turn-2">Your Turn</h3>

<ul>
  <li>When a user connects. Broadcast a message to all of the other clients connected announcing that someone new has connected.</li>
  <li>When a user disconnects. Broadcast a message to all of the other clients connected announcing that someone new has disconnected.</li>
  <li>When a message comes in from a user. Broadcast it out to all users.</li>
</ul>

<h2 id="pair-project">Pair Project</h2>

<p>We’re going to build a small chat room (like <a href="https://fullstack-denver.herokuapp.com/websockets/">this one</a>) using Socket.io and jQuery.
Users should be able to fill out a little form, which will send their message over the
WebSocket to the server, which will broadcast it out to all of the connected clients.</p>

<h3 id="extension">Extension</h3>

<ul>
  <li>Can you take advantage of <a href="https://www.npmjs.com/package/node-tweet-stream">node-tweet-stream</a> to stream tweets to your chatroom?</li>
</ul>

:ET