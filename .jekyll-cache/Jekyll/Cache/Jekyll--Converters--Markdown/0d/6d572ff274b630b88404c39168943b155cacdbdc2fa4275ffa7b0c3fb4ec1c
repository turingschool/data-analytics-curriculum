I"õA<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Students understand how JavaScript executes synchronously vs asynchronously</li>
  <li>Students can read and explain JavaScript that executes asynchronously</li>
  <li>Students are able to explain how asynchronous JavaScript can be handled</li>
</ul>

<h2 id="vocabulary">Vocabulary</h2>

<ul>
  <li>synchronous</li>
  <li>asynchronous</li>
  <li>call stack</li>
  <li>queue</li>
  <li>Web APIs</li>
  <li>Event Loop</li>
  <li>JS Engine/runtime</li>
</ul>

<h2 id="warm-up">Warm Up</h2>

<p>DISCUSS: If we ran this code, what would you expect to see in the console? Why?</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">firstFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">first</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">secondFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">second</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">thirdFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">third</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">firstFunction</span><span class="p">()</span>
<span class="nx">secondFunction</span><span class="p">()</span>
<span class="nx">thirdFunction</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="synchronous-vs-asynchronous">Synchronous vs. Asynchronous</h3>

<h4 id="synchronous-javascript">Synchronous JavaScript</h4>

<p>Let‚Äôs run the code from the Warm Up and verify our assumptions.</p>

<p>Now consider:</p>
<ul>
  <li>What if that second function was making a big network request?</li>
  <li>What if it was the second of 200 functions?</li>
  <li>What implications does that have for a user?</li>
</ul>

<p>BOTTOM LINE: If we could only run synchronous code in the browser, we couldn‚Äôt keep up with what users expect from applications. Say hello to asynchronous code, brought to you by your browser!</p>

<h2 id="intro">Intro</h2>

<h3 id="when-will-we-need-this">When Will We Need This?</h3>

<p>The concepts we‚Äôre going to talk about happen most often in the following situations:</p>

<ul>
  <li>Loading external data (APIs, files, databases)</li>
  <li>Events (clicks, keydowns, scrolls, etc)</li>
</ul>

<h4 id="the-event-loop">The Event Loop</h4>

<p>We now know that JavaScript runs synchronously.</p>

<p>JavaScript‚Äôs <strong>call stack</strong> is a data structure that keeps track of where we are in the sense of this synchronous thread of execution.</p>

<blockquote>
  <p>‚ÄúIf we step into a function, we step into the stack. If we return from a function, we pop off the top of the stack.‚Äù - Philip Roberts</p>
</blockquote>

<p>Asynchronous processes are able to run concurrently because, while the JS runtime can only execute a single thread, your browser provides more threads for you. Async takes advantage of this and passes processes to JavaScript‚Äôs <strong>queue</strong>, and one by one, once the async process is finished, the <strong>event loop</strong> will grab from the queue and put the process back onto the <strong>stack</strong>.</p>

<p>Let‚Äôs watch Philip Roberts further explain: <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ">Philip Roberts, JSConf EU 2014</a></p>

<h2 id="application-of-knowledge">Application of Knowledge</h2>

<h3 id="experiments-in-ordering">Experiments in Ordering</h3>

<p>With your partner, take your assign chunk of code and try to predict what interactions will happen. <strong>Then</strong> run the code in your browser‚Äôs console to verify your assumptions.</p>

<ol>
  <li>Snack Time</li>
</ol>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">hungry</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">very</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hungry</span><span class="p">);</span>

<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">hungry</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">not anymore</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`async hungry is </span><span class="p">${</span><span class="nx">hungry</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hungry</span><span class="p">);</span>
</code></pre></div></div>

<ol>
  <li>Ballon</li>
</ol>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">balloon</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">empty</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">balloon</span><span class="p">);</span>

<span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">body</span><span class="dl">'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">balloon</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">filled</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`async balloon is </span><span class="p">${</span><span class="nx">balloon</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">balloon</span><span class="p">);</span>
</code></pre></div></div>

<ol>
  <li>Repos</li>
</ol>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">repos</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">repos</span><span class="p">);</span>

<span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://api.github.com/users/turingschool/repos</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">allRepos</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">repos</span> <span class="o">=</span> <span class="nx">allRepos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">repos</span><span class="p">);</span>
  <span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">repos</span><span class="p">);</span>
</code></pre></div></div>
<p>Once you‚Äôve made sense of why this worked the way it did, whiteboard (or make a poster) a visual to show what happened with the call stack in the code snippet you chose.</p>

<h3 id="callbacks">Callbacks</h3>

<p>Callbacks, by nature are not asynchronous. They are, however, used widely by asynchronous code.</p>

<p>As a refresher, a <code class="highlighter-rouge">callback</code> is a second function that is being passed as a parameter to a first function and will be invoked by the original function.</p>

<p>For example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">doubleNumber</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">doubleNumber</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="callbacks-with-events">Callbacks with Events</h4>

<p>You‚Äôve seen callbacks before in array prototypes (think, Ruby enumerables), but also in event listeners. Take this example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#my-button</span><span class="dl">"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">You clicked my button!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div></div>

<p>You‚Äôve probably seen a click event handled like this before. You pass a function to be executed later upon a <code class="highlighter-rouge">'click'</code> event. I want to frame this in a slightly different way to help you understand how JavaScript interprets this. I‚Äôm going to write the same thing in without jQuery to help illustrate.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">my-button</span><span class="dl">'</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">You clicked by button!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div></div>

<p>The method <code class="highlighter-rouge">addEventListener()</code> does a better job of telling you what‚Äôs actually happening. When writing asynchronous JavaScript, it can sometimes feel like your code is being run out of order. JavaScript is still being read from top to bottom. When it gets to the <code class="highlighter-rouge">addEventListener()</code>, it does just that. It adds a listener to the element, and it moves on to its next instruction. It‚Äôs not that JavaScript comes back to this code later. You packed it up and sent it off. Your callback function now exists all alone, waiting to be invoked by the browser upon a ‚Äòclick‚Äô event.</p>

<h4 id="callbacks-with-asynchronicity">Callbacks with Asynchronicity</h4>

<p><code class="highlighter-rouge">setTimeout()</code> is another function that takes a callback. It‚Äôs an easy way to play around with asynchronicity. It is also tied to an event, but that event happens to be ‚Äúsome number of milliseconds passed‚Äù.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">1 second has passed</span><span class="dl">"</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">setTimeout()</code> sends its callback function to the event loop. After 1000 milliseconds (2nd parameter), the callback function (1st parameter) is then added back to the queue, ready to be added back to the stack once the stack is free.</p>

<h3 id="promises"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a></h3>

<p>Promises solve a similar problem as callbacks. They execute an asynchronous processes and can handle both the finished success or failure of said process. The technical definition of a promise is: <code class="highlighter-rouge">an object representing the eventual completion or error of an operation, along with a value.</code> A couple things to keep in mind about promises while we‚Äôre seeing them in action:</p>

<ul>
  <li>A <code class="highlighter-rouge">Promise</code> is yet another data type in JavaScript. You can assign it to a variable, it has methods and you can create new instances of it.</li>
  <li>The methods of <code class="highlighter-rouge">Promise</code> (specifically <code class="highlighter-rouge">.then()</code>) make more sense in the context of ‚Äúexecuting things in order‚Äù rather than ‚Äúpacking up code for later‚Äù</li>
</ul>

<p>Let‚Äôs take a few minutes to read through MDN‚Äôs <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise documentation</a>. Pay attention to the structure you see implemented in their examples.</p>

<p>To reiterate, a promise is like an egg. It‚Äôs in one of three states:</p>
<ul>
  <li>Growing a little chicken (pending)</li>
  <li>Hatched as a chicken (fulfilled, resolved)</li>
  <li>On my breakfast plate (rejected, failed)</li>
</ul>

<p><img src="http://www.tashakheiriddin.com/wp-content/uploads/2016/12/chicken-or-egg2.jpg" alt="inline" /></p>

<h4 id="wrap-up">Wrap Up</h4>

<p>Write your answers to the following in your notebook:</p>

<ul>
  <li>What‚Äôs something you can do with promises that you can‚Äôt do with callbacks?</li>
  <li>How would you describe asynchronicity to a 5 year old?</li>
</ul>

<h2 id="going-further">Going Further</h2>

<p>Here‚Äôs a couple JavaScript concepts you‚Äôll sometimes see associated with asynchronicity. They‚Äôre worth glancing over to avoid being completely confused when you come across them.</p>

<p><strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*">Generators</a></strong></p>

<p>A lot of the same ‚Äúrunning code at a later time‚Äù can be done using generators. You know you‚Äôre working with a generator when the function has a <code class="highlighter-rouge">*</code> at the end, and the keyword <code class="highlighter-rouge">yield</code> is used inside the function.</p>

<p><strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">Async and Await</a></strong></p>

<p>These are a pair of keywords defined in ES7. They‚Äôre just another way to ensure that things happen in a given order, but not necessarily at any given time.</p>
:ET