I"Ã1<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://www.dropbox.com/sh/iwlgfajecdr3bt1/AAAgVD8WrTvcQMbuLBsNyuApa?dl=0">Slides</a></li>
  <li><a href="http://tutorials.jumpstartlab.com/academy/workshops/revisiting_authentication_and_authorization.html">Tutorial</a></li>
</ul>

<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Students will implement user-level authorization</li>
  <li>Students will be able to explain the advantages of user-based authorization over role-based authorization</li>
  <li>Students will implement basic authentication with Devise</li>
</ul>

<h2 id="structure">Structure</h2>

<ul>
  <li>5 - Warmup</li>
  <li>5 - CanCan and the Challenges of Multi-Tenancy</li>
  <li>5 - Strategy One: Defining Abilities with Blocks</li>
  <li>5 - Strategy Two: Hash of Conditions</li>
  <li>5 - Stacking Permissions</li>
  <li>5 - Break</li>
  <li>10 - Authorization scopes and <code class="highlighter-rouge">accessible_by</code></li>
  <li>45 - Pair Practice</li>
  <li>5 - Wrap Up</li>
</ul>

<h2 id="warm-up">Warm-Up</h2>

<p>In a gist or your notebook or the text editor of your choice:</p>

<p>Role-based authorization worked in Dinner Dash, where you were hosting the menu and items from just one restaurant.</p>

<p>But what if you were more like GrubHub and hosted multiple restaurants? How would you prevent the admin of one restaurant from editing the content of another restaurant?</p>

<h2 id="full-group-lecture">Full-Group Lecture</h2>

<h3 id="introduction">Introduction</h3>

<p>Brief review of role-based authentication and CanCan.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Ability</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">role?</span> <span class="ss">:admin</span>
      <span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="ss">:all</span>
    <span class="k">else</span>
      <span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="ss">:all</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Just because you are an admin for one restaurant, it doesnâ€™t mean you should be an admin for <em>all</em> restaurants and be able to adjust your competitorâ€™s menu items and prices.</p>

<h3 id="setting-up-user-based-authorization">Setting Up User-Based Authorization</h3>

<p>So, how can we limit which actions the user can engage to just those that they own?</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Update this to reflect whatever my example is</span>
<span class="k">class</span> <span class="nc">Ability</span>
  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>

    <span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Item</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
      <span class="n">item</span><span class="p">.</span><span class="nf">try</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="o">==</span> <span class="n">item</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>There are two problems with this:</p>

<ol>
  <li>Itâ€™s ugly and verbose.</li>
  <li>The block is <strong>only</strong> evaluated when an actual instance object is present. It is not evaluated when checking permissions on the class (such as in the index action). This means any conditions which are not dependent on the object attributes should be moved outside of the block.</li>
</ol>

<h3 id="using-a-hash-of-conditions">Using a Hash of Conditions</h3>

<p>Okay, but this a little verbose. To make this a little easier on the eyes, we can use a <em>hash of conditions</em>.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Update this to reflect whatever my example is</span>
<span class="c1"># In Ability</span>
<span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Item</span><span class="p">,</span> <span class="ss">:active</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>
</code></pre></div></div>

<h3 id="stacking-authorizations">Stacking Authorizations</h3>

<p>It is important to only use database columns for these conditions so it can be used for Fetching Records.</p>

<p>If we need to get more granular, we can stack authorizations.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Item</span><span class="p">,</span> <span class="ss">active: </span><span class="kp">true</span>
<span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Item</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span>
</code></pre></div></div>

<p>It is possible to define multiple abilities for the same resource. Here the user will be able to read projects which are released <em>OR</em> available for preview.</p>

<p>The cannot method takes the same arguments as can and defines which actions the user is unable to perform. This is normally done after a more generic can call.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">Item</span><span class="p">,</span> <span class="ss">organization_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">organization</span><span class="p">.</span><span class="nf">id</span>
<span class="n">cannot</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="no">Item</span><span class="p">,</span> <span class="ss">owner_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span>
</code></pre></div></div>

<p>We can weave these together to create some find-grained control over what a user can and cannot do.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># In Ability</span>
<span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">User</span><span class="p">,</span> <span class="ss">manager_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span>
<span class="n">cannot</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">User</span><span class="p">,</span> <span class="ss">self_managed: </span><span class="kp">true</span>
<span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">User</span><span class="p">,</span> <span class="ss">id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span>
</code></pre></div></div>

<p>In this example, the user could manage himself. For others he could not manage self_managed users, otherwise he could manage his employees.</p>

<h3 id="fetching-records-based-on-authorization">Fetching Records Based on Authorization</h3>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># current_ability is a method made available by CanCan to your controllers extending ActionController::Base</span>
<span class="vi">@items</span> <span class="o">=</span> <span class="no">Item</span><span class="p">.</span><span class="nf">accessible_by</span><span class="p">(</span><span class="n">current_ability</span><span class="p">)</span>
</code></pre></div></div>

<p>By default, this will scope your query to bring back only the resources that the current user can :read.</p>

<p>If we want to get more specific, we can pass a second argument for the ability weâ€™d like to use.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@items</span> <span class="o">=</span> <span class="no">Item</span><span class="p">.</span><span class="nf">accessible_by</span><span class="p">(</span><span class="n">current_ability</span><span class="p">,</span> <span class="ss">:update</span><span class="p">)</span>
</code></pre></div></div>

<p>Remember that block syntax we looked at before? Well, thatâ€™s cool as long as youâ€™re working with Ruby objects. To fetch records from the database, youâ€™ll need to supply an SQL string.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Item</span><span class="p">,</span> <span class="p">[</span><span class="s2">"release_date &lt;= ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
  <span class="n">item</span><span class="p">.</span><span class="nf">release_date</span> <span class="o">&lt;=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can use scopes too, which is pretty awesome.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Item</span><span class="p">,</span> <span class="no">Item</span><span class="p">.</span><span class="nf">released</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
  <span class="n">item</span><span class="p">.</span><span class="nf">release_date</span> <span class="o">&lt;=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="group-code-along">Group Code-Along</h2>

<p>As a group, letâ€™s work through Part 1 of <a href="http://tutorials.jumpstartlab.com/academy/workshops/revisiting_authentication_and_authorization.html">this tutorial</a>.</p>

<p>Weâ€™ll be working with the <a href="https://github.com/turingschool-examples/storedom/tree/authorization-revisited"><code class="highlighter-rouge">authorization-revisited</code> branch</a> of <a href="https://github.com/turingschool-examples/storedom">Storedom</a>.</p>

<ul>
  <li>af571fb - Add Devise gem</li>
  <li>4e90e94 - Get Devise up and running</li>
  <li>21d999f - Clean up navbar slightly</li>
  <li>3a14a86 - Clean up Devise templates</li>
  <li>2b6b71d - Add CanCanCan to Gemfile</li>
  <li>bbb959e - Can CanCanCan CanCan?</li>
  <li>2e4f5ce - Clear out CanCanCan defaults</li>
  <li>88ada1d - Implement order scoping based on user</li>
</ul>

<p>In the commits above, we didnâ€™t capture the minutia of setting up <code class="highlighter-rouge">devise</code> and <code class="highlighter-rouge">cancancan</code>. Each one has a generator that helps set everything up.</p>

<ul>
  <li><a href="https://github.com/plataformatec/devise#getting-started">Getting Started with Devise</a></li>
  <li><a href="https://github.com/CanCanCommunity/cancancan#getting-started">Getting Started with CanCanCan</a></li>
</ul>

<h2 id="pair-practice">Pair Practice</h2>

<p>In pairs, work through Part 2 and Part 3 of <a href="http://tutorials.jumpstartlab.com/academy/workshops/revisiting_authentication_and_authorization.html">this tutorial</a>.</p>

:ET