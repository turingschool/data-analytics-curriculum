I"¨c<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Understand where Rails looks for client-side assets in your application</li>
  <li>Add assets to manifests to create asset bundles</li>
  <li>View and modify the asset pipeline load path</li>
  <li>Learn when not to use asset pipeline manifests</li>
</ul>

<h2 id="resources">Resources</h2>

<p><a href="https://www.dropbox.com/s/ajifnbjzogvxyff/Turing%20-%20Understanding%20the%20Asset%20Pipeline.key?dl=0">Slides</a></p>

<p><a href="https://gist.github.com/jmejia/8f6507d3faa92ff21f0b">Starting a Rails app in production</a></p>

<p><a href="https://github.com/rails/sprockets-rails">Sprockets</a></p>

<h2 id="warm-up">Warm Up</h2>

<p>When building a Rails application, we tend to just assume that jQuery is readily available for us. If we open up the Chrome Developer Tools, we‚Äôll see that our Rails application is loading jQuery.</p>

<p>Where is it coming from?</p>

<h2 id="lecture">Lecture</h2>

<p>Source files go in one end; if necessary, they get processed and compiled (think SASS or CoffeeScript); they get concatenated and compressed and spit out the other end as bundles.</p>

<p>The asset pipeline relies on a few technologies:</p>

<ul>
  <li><strong>Sprockets</strong> is a Rack-based asset packaging for compiling and serving web assets. It handles dependency management and preprocesses CoffeeScript, SASS, et cetera on your behalf.</li>
  <li><strong>Tilt</strong> is a wrapper around a number of Ruby template engines, giving them a common interface. You can take a look at all of the formats Tilt can handle by <a href="https://github.com/rtomayko/tilt/blob/master/README.md">checking out the documentation</a>.</li>
</ul>

<p>So, why should you use the asset pipeline? Inline JavaScript (mixed in your HTML/ERB code) blocks loading and rendering the page‚Äîwhich is not something we usually want to block. Plus it is messy to mix JavaScript, Ruby, and HTML in a view template. Let‚Äôs keep JavaScript in its own files in the Rails assets directories.</p>

<p>Rails will pick up new files in your <code class="highlighter-rouge">app/assets</code> directory, but you have to reset the server if you add a new <em>directory</em> to the <code class="highlighter-rouge">app/assets</code>.</p>

<p>Rails pulls in assets from the following locations:</p>

<ul>
  <li><code class="highlighter-rouge">app/assets</code></li>
  <li><code class="highlighter-rouge">lib/assets</code></li>
  <li><code class="highlighter-rouge">vendor/assets</code></li>
  <li>Gems with a <code class="highlighter-rouge">vendor/assets</code> directory.</li>
</ul>

<p><code class="highlighter-rouge">vendor/assets</code> is a good place for third-party JavaScript libraries that aren‚Äôt yours (e.g. Underscore.js, D3). <code class="highlighter-rouge">lib/assets</code> is typically used for assets that are created by your team but used by multiple applications. <code class="highlighter-rouge">app/assets</code> are your application-specific assets.</p>

<p>By default, Rails places three sub-directories in your <code class="highlighter-rouge">app/assets</code> directory. These are completely arbitrary. You can name these directories whatever you want or add other directories to your heart‚Äôs content.</p>

<p>Anything in the pipeline will be available at the <code class="highlighter-rouge">/assets</code> URL. So, the <code class="highlighter-rouge">app/assets/javascripts/application.js</code> in your asset pipeline will be available in development at <code class="highlighter-rouge">http://localhost:3000/assets/application.js</code>. <code class="highlighter-rouge">app/assets/stylesheets/application.css</code> will also be available at the root of your asset directory. The asset pipeline will completely flatten your directory structure when you spin up your development server or precompile your assets.</p>

<p><strong>Try it Out:</strong></p>

<ul>
  <li>Clone <a href="https://github.com/turingschool-examples/storedom-5">turingschool-examples/storedom-5</a> and do the necessary prep work (<code class="highlighter-rouge">bundle</code>, the requisite <code class="highlighter-rouge">rake</code> tasks). This new version will use Ruby 2.4 and Rails5.</li>
  <li>Create a directory in <code class="highlighter-rouge">app/assets</code> called <code class="highlighter-rouge">texts</code>.</li>
  <li>Add a text file‚Äîlet‚Äôs call it <code class="highlighter-rouge">hello.txt</code>‚Äîto <code class="highlighter-rouge">app/assets/texts</code> and give it some contents.</li>
  <li>Fire up the server and visit <code class="highlighter-rouge">http://localhost:3000/assets/hello.txt</code>.</li>
  <li>Move it to <code class="highlighter-rouge">app/assets/javascripts</code> and refresh the page.</li>
  <li>Create a file called <code class="highlighter-rouge">hello.js</code> in <code class="highlighter-rouge">app/assets/javascripts</code>.</li>
</ul>

<p>At it‚Äôs core, the asset pipeline is a list of load paths. You can see these load paths by firing up the Rails console.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">paths</span>
</code></pre></div></div>

<p>(The <code class="highlighter-rouge">y</code> command just formats the hash as YAML.)</p>

<p>You‚Äôll typically see something like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/Projects/storedom/app/assets/images"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/Projects/storedom/app/assets/javascripts"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/Projects/storedom/app/assets/stylesheets"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/Projects/storedom/vendor/assets/javascripts"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/Projects/storedom/vendor/assets/stylesheets"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/.rvm/gems/ruby-2.1.3/gems/less-rails-bootstrap-3.2.0/app/assets/fonts"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/.rvm/gems/ruby-2.1.3/gems/less-rails-bootstrap-3.2.0/app/assets/javascripts"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/.rvm/gems/ruby-2.1.3/gems/less-rails-bootstrap-3.2.0/app/assets/stylesheets"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/.rvm/gems/ruby-2.1.3/gems/turbolinks-2.2.2/lib/assets/javascripts"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/.rvm/gems/ruby-2.1.3/gems/jquery-rails-3.1.1/vendor/assets/javascripts"</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">/Users/stevekinney/.rvm/gems/ruby-2.1.3/gems/coffee-rails-4.0.1/lib/assets/javascripts"</span>
</code></pre></div></div>

<p>The asset pipeline works its way through your load path. The first asset with a given name wins. If you had an asset named <code class="highlighter-rouge">app/assets/stylesheet.css.scss</code> and another called <code class="highlighter-rouge">vendor/assets/stylesheet.css.scss</code>, the asset in your <code class="highlighter-rouge">app/assets</code> directory would win because it occurs first in the load path.</p>

<h4 id="adding-to-the-search-path">Adding to the Search Path</h4>

<p>By default, Rails will search the first set of directories directly under <code class="highlighter-rouge">app/assets</code>, <code class="highlighter-rouge">lib/assets</code>, <code class="highlighter-rouge">vendor/assets</code>. You can add additional paths to the asset pipeline, if your heart desires.</p>

<p>Let‚Äôs say you‚Äôre living in the future and you want to include some Adobe Flash. And in an effort to avoid infecting your other assets with a case of the early 2000s, you want to store your flashy Flash apps in <code class="highlighter-rouge">app/flash/assets</code>. By default Rails won‚Äôt know to look for assets in this location, but we can tell it to do so. To do this, edit the configuration in <code class="highlighter-rouge">config/initializers/assets.rb</code>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">precompile</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"app"</span><span class="p">,</span> <span class="s2">"flash"</span><span class="p">,</span> <span class="s2">"assets"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Your Turn</strong></p>

<p>Create a new asset directory somewhere in your application (perhaps <code class="highlighter-rouge">app/pizzas/scripts</code> would be a good candidate). Add a JS file to this directory and see if you can load it from the server. (you shouldn‚Äôt be able to).</p>

<p>Add the new directory to the asset load path and make sure you can load it now. Once that‚Äôs working, see what happens if you rename it to <code class="highlighter-rouge">hello.txt</code> or <code class="highlighter-rouge">hello.js</code>.</p>

<h3 id="manifests">Manifests</h3>

<p>When developing our application‚Äôs frontend, we like to separate our code into multiple files according to its function or responsibility. This helps keep things manageable and organized as our application grows, especially in Apps that involve a lot of JS or CSS.</p>

<p>However, when serving assets to an end user, this becomes problematic. In development, it is tedious to have to individually require a lot of small asset files in our templates. In production, having lots of asset files is even worse, since it bogs down the page with lots of HTTP requests.</p>

<p>Fortunately Rails gives us asset manifests to help with these issues. Manifests are a way to pull in groups of related files. So, if I request <code class="highlighter-rouge">application.js</code> and it requires <code class="highlighter-rouge">another.js</code> in it‚Äôs manifest, I will get both of them. It‚Äôs common to see a single large manifest (e.g. <code class="highlighter-rouge">application.js</code>) that pulls in everything, but we can also segment our assets into smaller manifests that are only used on specific portions of the site (e.g. <code class="highlighter-rouge">admin.js</code>).</p>

<p>When writing an asset manifest, we can use special ‚Äúdirectives‚Äù to tell Sprockets what to pull in to the bundle. Directives are written as comments in the appropriate manifest file. Here are a few examples (see below for a complete list):</p>

<ul>
  <li><code class="highlighter-rouge">// require_tree .</code> requires all of the files in that directory and all subdirectories.</li>
  <li><code class="highlighter-rouge">// require_directory .</code> loads all of the files in the directory but <em>not</em> the subdirectories.</li>
  <li>Alternatively, you can just take matters into you own hands and manually define the files you want to include.</li>
</ul>

<p>In this example, we‚Äôre looking at <code class="highlighter-rouge">application.js</code>; so, we‚Äôre using JavaScript comments. If you‚Äôre in <code class="highlighter-rouge">application.css</code> then it would be in CSS comments.</p>

<p>By default, the asset pipeline concatenates all of assets into one file (using <code class="highlighter-rouge">require_tree .</code>). Browsers can only make a limited number of requests in parallel. This technique allows you to get all of your assets with one request.</p>

<p>Here‚Äôs an example of an <code class="highlighter-rouge">application.js</code> manifest from Storedom:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require twitter/bootstrap</span>
<span class="c1">//= require turbolinks</span>
<span class="c1">//= require_tree .</span>
</code></pre></div></div>

<p><strong>Discussion/Question:</strong> Why are <code class="highlighter-rouge">jquery</code> and our other external JS libraries not picked up by <code class="highlighter-rouge">require_tree .</code></p>

<h4 id="manifest-directives">Manifest Directives</h4>

<ul>
  <li><code class="highlighter-rouge">require</code> grabs an asset and puts it in our bundle once.</li>
  <li><code class="highlighter-rouge">include</code> works a lot like <code class="highlighter-rouge">require</code>, but it will allow you to include a file more than once. (I have yet to find a practical use for this directive.)</li>
  <li><code class="highlighter-rouge">require_self</code> tells Sprockets to load the body of the current file before loading any of the dependencies. You would use this if you wrote any styles or JavaScript in <code class="highlighter-rouge">application.css</code> or <code class="highlighter-rouge">application.js</code> respectively and you wanted Sprockets to load that code before loading any of the required assets.</li>
  <li><code class="highlighter-rouge">require_directory</code> requires all of the source files of the same format in a given directory. It only goes one level deep.</li>
  <li><code class="highlighter-rouge">require_tree</code> works like <code class="highlighter-rouge">require_directory</code>, but it also traverses subdirectories.</li>
  <li><code class="highlighter-rouge">depend_on</code> announces that you depend on a file, but does not include it in the asset bundle.</li>
  <li><code class="highlighter-rouge">stub</code> blacklists a dependency from the bundle.</li>
</ul>

<h4 id="a-quick-note-on-sassscss">A Quick Note on SASS/SCSS</h4>

<p>Sure, you could require and concatenate multiple <code class="highlighter-rouge">.scss</code> files using manifests, but you probably shouldn‚Äôt. The asset pipeline is fairly agnostic to the special features of the assets you‚Äôre working with. SASS has an <code class="highlighter-rouge">@import</code> directive that works better for our purposes. In this case, it‚Äôs better to just include <code class="highlighter-rouge">@import</code> directives in your <code class="highlighter-rouge">application.css.scss</code> than it is to use manifest directives.</p>

<p>You can also do something similar with JavaScript, but it‚Äôs a little more intensive, so for now, we‚Äôll use manifests to concatenate our scripts.</p>

<h4 id="md5-fingerprints--asset-caching">MD5 Fingerprints / Asset Caching</h4>

<p>It‚Äôs beyond the scope of this discussion, but caching assets is a large topic in the field of web infrastructure. Retrieving assets over and over adds a lot of network overhead to web applications, so browsers (as well as network intermediaries like CDN‚Äôs) do everything they can to cache assets.</p>

<p>But if assets are being cached on the browser side, we need a way to update them when necessary. Otherwise our application might get loaded with out-of-date assets (for example, old javascript with a new set of incompatible markup).</p>

<p>If you look at the assets generated by a Rails application, you‚Äôll notice that each includes a string of letters and numbers as part of the filename. This string of numbers is a ‚Äúdigest‚Äù of all of the asset contents, which allows us to ensure that any change to the underlying asset will generate a completely new filename and URL, thus breaking any asset caches that might have been in place.</p>

<h3 id="actionview-helpers">ActionView Helpers</h3>

<p>ActionView gives you a set of helper methods that you can use in your views to include assets.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">"all"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"application"</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>In addition to including scripts and stylesheets, you can also use ActionView helpers to include media content.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">audio_path</span><span class="p">(</span><span class="s2">"horse.wav"</span><span class="p">)</span>   <span class="c1"># =&gt; /audios/horse.wav</span>
<span class="n">audio_tag</span><span class="p">(</span><span class="s2">"sound"</span><span class="p">)</span>        <span class="c1"># =&gt; &lt;audio src="/audios/sound" /&gt;</span>
<span class="n">font_path</span><span class="p">(</span><span class="s2">"font.ttf"</span><span class="p">)</span>     <span class="c1"># =&gt; /fonts/font.ttf</span>
<span class="n">image_path</span><span class="p">(</span><span class="s2">"edit.png"</span><span class="p">)</span>    <span class="c1"># =&gt; "/images/edit.png"</span>
<span class="n">image_tag</span><span class="p">(</span><span class="s2">"icon.png"</span><span class="p">)</span>     <span class="c1"># =&gt; &lt;img src="/images/icon.png" alt="Icon" /&gt;</span>
<span class="n">video_path</span><span class="p">(</span><span class="s2">"hd.avi"</span><span class="p">)</span>      <span class="c1"># =&gt; /videos/hd.avi</span>
<span class="n">video_tag</span><span class="p">(</span><span class="s2">"trailer.ogg"</span><span class="p">)</span>  <span class="c1"># =&gt; &lt;video src="/videos/trailer.ogg" /&gt;</span>
</code></pre></div></div>

<p>See <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/AssetTagHelper.html">ActionView::Helpers::AssetTagHelper</a> documentation for more information.</p>

<p>The <code class="highlighter-rouge">sass-rails</code> gem also has <a href="https://github.com/rails/sass-rails#asset-helpers">a set of helpers</a> that allow you to reference other assets without having to know their exact location. This should help you resist the temptation of using ERB in your <code class="highlighter-rouge">.scss</code> assets.</p>

<h3 id="differences-in-development-and-production">Differences in Development and Production</h3>

<p>As we mentioned in the beginning, the whole idea of the asset pipeline is to concatenate everything into one file, because performance. But, we‚Äôll notice that when we spin up our application in development, we‚Äôll see many files listed in the resources tab of the Chrome Developer Tools.</p>

<p>This is because this functionality is disabled in <code class="highlighter-rouge">config/environments/development.rb</code>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Debug mode disables concatenation and preprocessing of assets.</span>
<span class="c1"># This option may cause significant delays in view rendering with a large</span>
<span class="c1"># number of complex assets.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<p>This is useful for debugging JavaScript and CSS issues. It‚Äôs turned off in production.</p>

<h4 id="precompiling-assets">Precompiling Assets</h4>

<p>If you request an asset in development, Rails will check <code class="highlighter-rouge">public/assets</code> first. If your asset is not there, it will hit up the asset pipeline and compile it on the fly. This is useful in development because you‚Äôre likely to be making frequent changes and edits to those files. But, it would also be a performance bottleneck in production if Rails had to compile those files on every request.</p>

<p>If you want to use an asset in your application, it has to either be required by a file in your asset pipeline or precompiled.</p>

<p>Let‚Äôs say you had a stylesheet called <code class="highlighter-rouge">site.css.scss</code>. You could simply require it in <code class="highlighter-rouge">application.css</code>.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">//</span> <span class="o">=</span> <span class="nt">require_self</span>
<span class="o">//</span> <span class="o">=</span> <span class="nt">require</span> <span class="s2">'site'</span>
</code></pre></div></div>

<p>Alternatively, you can add it to the precompile list similar to the way we added a load path earlier.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">precompile</span> <span class="o">+=</span> <span class="sx">%w( site.css )</span>
</code></pre></div></div>

<p>When you run <code class="highlighter-rouge">rake assets:precompile</code>, Rails goes through your assets and copies everything over to <code class="highlighter-rouge">public/assets</code>. It then creates <code class="highlighter-rouge">application.js</code> and <code class="highlighter-rouge">application.css</code> by reading the manifests. It does not look at any other file unless you explicitly tell it to.</p>

<p>The confusing part here is that every file in your asset pipeline that is <em>not</em> a CSS or JavaScript file will be copied over to <code class="highlighter-rouge">public/assets</code>. JavaScripts and stylesheets must either be included in a manifest or explicitly added to the <code class="highlighter-rouge">config.assets.precompile</code> directive.</p>

<p>It‚Äôs also important to note, that when using <code class="highlighter-rouge">config.assets.precompile</code>, that the file extension of the target file matters. <code class="highlighter-rouge">config.assets.precompile += %w( site )</code> will not work.</p>

<h3 id="gemified-assets">Gemified Assets</h3>

<p>As we‚Äôve seen with <code class="highlighter-rouge">jquery-rails</code>, gems can be used to bundle client-side assets.</p>

<h4 id="engines">Engines</h4>

<p>In order to bundle client-side assets for inclusion in the the asset pipeline, you have to define an engine that inherits from <code class="highlighter-rouge">Rails::Engine</code>. Let‚Äôs take a look at how the <code class="highlighter-rouge">rails-jquery</code> does it by checking out <code class="highlighter-rouge">lib/jquery/rails/engine.rb</code>.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Jquery</span>
  <span class="k">module</span> <span class="nn">Rails</span>
    <span class="k">class</span> <span class="nc">Engine</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Engine</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>There‚Äôs not a lot going on in this code, but it tells Rails, ‚ÄúHey! Look at me! Put my <code class="highlighter-rouge">vendor/assets</code> into the asset pipeline!‚Äù</p>

<p>If you use an <code class="highlighter-rouge">index.js</code> or <code class="highlighter-rouge">index.css</code>, then you can require the whole gem without specifying a file.</p>

<p>Why would you want to use an <code class="highlighter-rouge">index.js</code>? Well, let‚Äôs say you broke your gem assets into multiple files -‚Äî probably a good idea. Using an <code class="highlighter-rouge">index.js</code>, allows you to be explicit about the order that these files should be included in.</p>

<h3 id="post-processing">Post-Processing</h3>

<p>In production, Rails will minify your assets to help you conserve bandwidth. Rails has some sensible defaults that you‚Äôre welcome to override if you‚Äôd like.</p>

<ul>
  <li>Stylesheets are compressed with the YUI Compressor. You can also use the standard SASS compressor by by setting <code class="highlighter-rouge">config.assets.css_compressor = :sass</code>.</li>
  <li>JavaScript is compressed using Uglifier, but you can set <code class="highlighter-rouge">config.assets.js_compressor</code> to <code class="highlighter-rouge">:closure-compiler</code>, <code class="highlighter-rouge">:uglifier</code> or <code class="highlighter-rouge">:yui-compressor</code>.</li>
</ul>

<h3 id="resources-1">Resources</h3>

<ul>
  <li><a href="https://gist.github.com/rwarbelow/40bd72b2aee8888d6d91">Running your app in production</a></li>
</ul>
:ET