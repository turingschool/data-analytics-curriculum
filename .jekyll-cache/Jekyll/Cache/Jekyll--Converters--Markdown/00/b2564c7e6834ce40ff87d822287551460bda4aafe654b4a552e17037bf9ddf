I"≈O<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Write a web server in raw Ruby (as opposed to using a web framework like Rails)</li>
  <li>Parse Requests in raw Ruby</li>
  <li>Generate Responses in raw Ruby</li>
</ul>

<h2 id="background">Background</h2>

<p>The internet, which for most people is the web‚Ä¶how does that work?</p>

<ul>
  <li>The <strong>Internet</strong> is the network between devices that allows them to exchange information</li>
  <li>Devices fall in to two categories: <strong>Clients</strong> and <strong>Servers</strong>.</li>
  <li>Clients send <strong>Requests</strong> to Servers asking for some kind of information</li>
  <li>Upon receiving a Request, Servers send <strong>Responses</strong> back to the Client</li>
</ul>

<p><strong>HTTP</strong> is a set of rules for how this exchange of information happens. Clients and Servers adhere to these rules to ensure that they understand each other‚Äôs Requests and Responses.</p>

<p>Imagine you‚Äôre writing to a penpal. The process would look something like this:</p>

<ol>
  <li>Write a letter</li>
  <li>Specify your penpal‚Äôs address</li>
  <li>Drop the letter in your mailbox</li>
  <li>The letter goes through the postal system and arrives at your penpal‚Äôs mailbox</li>
</ol>

<p>Your penpal then goes through a very similar set of steps:</p>

<ol>
  <li>Read your letter and write a response</li>
  <li>Specify your address</li>
  <li>Drop their letter in their mailbox</li>
  <li>The letter goes through the postal system and arrives at your mailbox</li>
</ol>

<p>In this metaphor:</p>

<ul>
  <li>You are the <strong>Client</strong></li>
  <li>Your penpal is the <strong>Server</strong></li>
  <li>Your letter is the <strong>Request</strong></li>
  <li>Your penpal‚Äôs letter is the <strong>Response</strong></li>
  <li>The postal system, the thing responsible for ensuring your letters are delivered, is <strong>The Internet</strong></li>
</ul>

<p><strong>HTTP</strong> is the language you write in so that your penpal can understand you. You may write in English because you know you both understand English. If you wrote a letter in Spanish and your penpal only spoke English, they might write you a letter back saying ‚ÄúPlease write to me in English‚Äù.</p>

<p>Metaphor aside, let‚Äôs run through the protocol as executed by computers:</p>

<ol>
  <li>You open your browser, the Client, and type in a web address like <code class="highlighter-rouge">http://turing.io</code> and hit enter.</li>
  <li>The browser takes this address and builds an <strong>HTTP Request</strong>. It addresses it to the Server located at <code class="highlighter-rouge">http://turing.io</code>.</li>
  <li>The Request is handed off to your Internet Service Provider (ISP) (like CenturyLink or Comcast) and they send it through the Internet, mostly a series of wires and fiber optic cables, to the Server</li>
  <li>The Server reads the Request. It knows how to read it because it is formatted as an <strong>HTTP Request</strong>.</li>
  <li>The Server generates an <strong>HTTP Response</strong> to that Request.</li>
  <li>The server hands the Response off to their ISP and it goes through the internet to arrive at your computer.</li>
  <li>Your browser reads the Response. It knows how to read it because it is formatted as an <strong>HTTP Response</strong>.</li>
  <li>Your browser displays the data on your machine.</li>
</ol>

<p>That‚Äôs HTTP. At its core, it is a bunch of formatting rules that Clients and Servers use to talk to each other. You can read more on the <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">wikipedia page</a> or the <a href="https://tools.ietf.org/html/rfc2616">IETF specification</a>.</p>

<h1 id="http-tutorial">HTTP Tutorial</h1>

<p>In this tutorial, we will play the part of both the Server and Client. We will write the server in Ruby, and we will use a web browser, like Chrome or Safari, as the Client.</p>

<h2 id="starting-a-server">Starting a Server</h2>

<p>Add the following lines of code to a Ruby file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>
</code></pre></div></div>

<p>Run the file with <code class="highlighter-rouge">ruby &lt;filename&gt;</code> and you should see that nothing happens. So what do these lines of code do?</p>

<p>TCPServer is the Class we will use to create a new Server.</p>

<p>9292 is the <strong>Port</strong> that the Server runs on. The Port uniquely identifies a program running on a computer. Back to our penpal analogy, imagine your penpal lives in a large apartment building. You have to specify both the street address and the apartment number. Like an apartment building with many units, a computer has many programs running at once. In HTTP, we have to specify both the Server and the program within the Server we want to send our Request to.</p>

<p>Nothing is special about the Port we specified, 9292. It is just a number. You could just as easily change this number to 8181.</p>

<p>Update the file like so:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="c1"># Wait for a Request</span>
<span class="c1"># When a request comes in, save the connection to a variable</span>
<span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>
</code></pre></div></div>

<p>The last line is telling the server to wait for a Request. When our server gets a Request, we are saving the connection to a variable called <code class="highlighter-rouge">connection</code>. This connection object is an open door between our Server and Client that the Server will use to read the Request and send back the Response. If you run the file now, you should see <code class="highlighter-rouge">Waiting for Request...</code> printed to your terminal which then hangs. Success! Your Server is now running. Use <code class="highlighter-rouge">ctrl + c</code> to stop the Server.</p>

<h2 id="address-in-use-errors">Address In Use Errors</h2>

<p><code class="highlighter-rouge">ctrl + c</code> gracefully ends our program, but sometimes things happen that make our program exit not so gracefully. One of these things is using <code class="highlighter-rouge">ctrl + z</code>. <strong>DO NOT</strong> use <code class="highlighter-rouge">ctrl + z</code>! This could result in the Port not being released, and you may at some point see an error like this:</p>

<p><code class="highlighter-rouge">Address already in use - bind(2) for nil port 9292 (Errno::EADDRINUSE)</code></p>

<p>If you get that error enter this command into your terminal:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsof -i:9292
</code></pre></div></div>

<p>and you should get output that looks like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COMMAND   PID  USER       FD   TYPE            DEVICE SIZE/OFF NODE NAME
ruby    63015 username    8u  IPv6  0xc5b438446726a53      0t0  TCP *:armtechdaemon (LISTEN)
</code></pre></div></div>

<p>Take that number under <code class="highlighter-rouge">PID</code>, in this case 63015, and enter:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kill -9 63015
</code></pre></div></div>

<p>Run your server file again and everything should be okay.</p>

<h2 id="reading-the-request">Reading the Request</h2>

<p>Update your file to look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="c1"># Wait for a Request</span>
<span class="c1"># When a request comes in, save the connection to a variable</span>
<span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>

<span class="c1"># Read the request line by line until we have read every line</span>
<span class="nb">puts</span> <span class="s2">"Got this Request:"</span>
<span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">end</span>

<span class="c1"># Print out the Request</span>
<span class="nb">puts</span> <span class="n">request_lines</span>
</code></pre></div></div>

<p>Run your file again and you should see your terminal hanging. Open up a web browser, like Google Chrome, and enter the following into the address bar:</p>

<p><code class="highlighter-rouge">localhost:9292</code></p>

<p>Go back to your terminal and you should see a print out of the request.</p>

<p>What we just did was start a Server and tell it to wait for a Request. Then we sent a Request using a web browser. When our Server got the Request, it read it and printed it out to the screen line by line.</p>

<p><strong>Answer the following questions in your notebook:</strong></p>

<ol>
  <li>Look at the request that was printed out. What is the verb?</li>
  <li>What is the path?</li>
  <li>What is the protocol?</li>
  <li>What is the first header?</li>
  <li>What is the last header?</li>
  <li>What is the body?</li>
</ol>

<h3 id="generating-the-response">Generating the Response</h3>

<p>If you look back at your web browser, it should say something like <code class="highlighter-rouge">localhost refused to connect</code>. Remember, the HTTP cycle includes both a request and a response. Right now, our program is quitting as soon as it gets a response.</p>

<p>Update your file with the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="c1"># Wait for a Request</span>
<span class="c1"># When a request comes in, save the connection to a variable</span>
<span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>

<span class="c1"># Read the request line by line until we have read every line</span>
<span class="nb">puts</span> <span class="s2">"Got this Request:"</span>
<span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">end</span>

<span class="c1"># Print out the Request</span>
<span class="nb">puts</span> <span class="n">request_lines</span>

<span class="c1"># Generate the Response</span>
<span class="nb">puts</span> <span class="s2">"Sending response."</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Hello from the Server side!&lt;/html&gt;"</span>
<span class="n">status</span> <span class="o">=</span> <span class="s2">"http/1.1 200 ok"</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">output</span>

<span class="c1"># Send the Response</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span>

<span class="c1"># close the connection</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">close</span>
</code></pre></div></div>

<p>Run this file and send a Request to <code class="highlighter-rouge">localhost:9292</code> from the browser just like before. You should see the text <code class="highlighter-rouge">Hello from the Server side</code> in your browser. We now have a successful Client/Server interaction! Notice that when we are done writing the Response, we need to close the connection.</p>

<p><strong>Answer the following questions in your notebook:</strong></p>

<ol>
  <li>For the response we generated, identify each part of the status line.</li>
  <li>Identify the headers we sent in the response.</li>
  <li>Identify the response body.</li>
</ol>

<p>After your Server sends a response, the program ends. If you try to refresh the page, you won‚Äôt get a connection. Let‚Äôs update our code so that the Server will continually accept Requests:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="kp">loop</span> <span class="k">do</span>
  <span class="c1"># Wait for a Request</span>
  <span class="c1"># When a request comes in, save the connection to a variable</span>
  <span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>

  <span class="c1"># Read the request line by line until we have read every line</span>
  <span class="nb">puts</span> <span class="s2">"Got this Request:"</span>
  <span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="k">end</span>

  <span class="c1"># Print out the Request</span>
  <span class="nb">puts</span> <span class="n">request_lines</span>

  <span class="c1"># Generate the Response</span>
  <span class="nb">puts</span> <span class="s2">"Sending response."</span>
  <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Hello from the Server side!&lt;/html&gt;"</span>
  <span class="n">status</span> <span class="o">=</span> <span class="s2">"http/1.1 200 ok"</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">output</span>

  <span class="c1"># Send the Response</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span>

  <span class="c1"># close the connection</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You should now be able to refresh the page multiple times and get a Response every time.</p>

<p><strong>Note:</strong> If you are using Google Chrome, it may send two requests. The first one is the one we are concerned with. Ignore the second one requesting the ‚Äúfavicon‚Äù.</p>

<h2 id="checks-for-understanding">Checks for Understanding</h2>

<ol>
  <li>Compare and contrast the code you wrote in this tutorial with the Rails apps you‚Äôve written</li>
  <li>Can you identify any code snippets from this tutorial that have a similar Rails component?</li>
  <li>Can you identify any Rails components that are missing from the code?</li>
  <li>Can you identify anything in this tutorial that we don‚Äôt have to do in Rails? If so, does Rails just do it for us? Or does it not do it at all?</li>
</ol>

<h2 id="extensions">Extensions</h2>

<h3 id="paths">Paths</h3>

<p>Right now, our app only generates one response. If you send a request to <code class="highlighter-rouge">localhost:9292/users</code>, <code class="highlighter-rouge">localhost:9292/unicorns</code>, or <code class="highlighter-rouge">locahost:9292/hello</code>, you will get the same response every time. Refactor your code so that your server can respond to different paths. You can pick whatever paths you want, but if you need some ideas:</p>

<ul>
  <li>Make you server respond to <code class="highlighter-rouge">/hello</code> with a greeting message</li>
  <li>Make your server to respond to <code class="highlighter-rouge">/bio</code> with a short biography for yourself</li>
  <li>Make your server respond to <code class="highlighter-rouge">/random</code> with a random number</li>
  <li>Make your server respond to any other path with a 404</li>
</ul>

<h3 id="verbs">Verbs</h3>

<p>Once you have made your server respond to a couple of different paths, try to make it respond to different verbs for the same path. For example, generate different responses for <code class="highlighter-rouge">GET /hello</code> and <code class="highlighter-rouge">POST /hello</code>.</p>
:ET