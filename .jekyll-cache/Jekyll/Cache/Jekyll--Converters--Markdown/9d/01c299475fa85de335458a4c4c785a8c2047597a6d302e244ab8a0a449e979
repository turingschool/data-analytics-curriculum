I"8<h2 id="goals">Goals</h2>

<h2 id="repository">Repository</h2>

<ul>
  <li><a href="https://github.com/turingschool-examples/active-record-sinatra/tree/intro_and_homework_complete">ActiveRecord Sinatra: Intro and Homework Complete</a>: This branch is the result of completing the ActiveRecord Sinatra lesson available <a href="https://github.com/turingschool/lesson_plans/blob/master/ruby_02-web_applications_with_ruby/outlines/intro_to_active_record_in_sinatra.markdown">here</a>, and the homework linked at the bottom of that lesson. At this point, students should have their own copy of this assignment, and should not have to clone this down.</li>
</ul>

<p>To clone and checkout the remote <code class="highlighter-rouge">intro_and_homework_complete</code> branch:</p>

<p><code class="highlighter-rouge">git clone -b intro_and_homework_complete git@github.com:turingschool-examples/active-record-sinatra.git</code></p>

<h2 id="warmup">Warmup</h2>

<p>Read <a href="https://robots.thoughtbot.com/four-phase-test">this</a> Thoughtbot article about the four-phase test design.</p>

<h2 id="intro-to-rspec">Intro to RSpec</h2>

<p>Will be using RSpec for this lesson.</p>

<ul>
  <li>Slightly different than Mini-Test, but not by much.
    <ul>
      <li><code class="highlighter-rouge">describe</code> blocks</li>
      <li>nested <code class="highlighter-rouge">describe</code> blocks</li>
      <li><code class="highlighter-rouge">it</code> blocks</li>
      <li><code class="highlighter-rouge">expect</code> instead of assert</li>
    </ul>
  </li>
  <li>Flags
    <ul>
      <li>–color</li>
      <li>–format=documentation</li>
      <li>Can save in a <code class="highlighter-rouge">.rspec</code> file in your home directory</li>
    </ul>
  </li>
</ul>

<h2 id="code-along">Code-Along</h2>

<h3 id="setting-up-model-tests">Setting up Model Tests</h3>

<p>Add the following line to your <code class="highlighter-rouge">Gemfile</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'rspec'</span>
</code></pre></div></div>

<p>Run <code class="highlighter-rouge">bundle</code>.</p>

<h3 id="file-structure">File structure</h3>

<p>We’ll create a spec folder. Within that folder, we’ll create another folder called models. This way we can separate our model tests from our integration tests (more on this later).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir spec
$ touch spec/spec_helper.rb
$ mkdir spec/models
$ touch spec/models/film_spec.rb
</code></pre></div></div>

<p>In <code class="highlighter-rouge">spec/spec_helper.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>
<span class="nb">require</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../config/environment.rb'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="testing-the-total_sales-method">Testing the <code class="highlighter-rouge">.total_sales</code> Method</h3>

<p>Let’s write our first model test. In <code class="highlighter-rouge">spec/models/film_spec.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'../spec_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"Film"</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">".total_sales"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"returns total sales for all films"</span> <span class="k">do</span>
      <span class="no">Film</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Film1"</span><span class="p">,</span> <span class="ss">year: </span><span class="mi">2012</span><span class="p">,</span> <span class="ss">box_office_sales: </span><span class="mi">3</span><span class="p">)</span>
      <span class="no">Film</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Film2"</span><span class="p">,</span> <span class="ss">year: </span><span class="mi">2013</span><span class="p">,</span> <span class="ss">box_office_sales: </span><span class="mi">2</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="no">Film</span><span class="p">.</span><span class="nf">total_sales</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>At this point you should be able to run your tests from the command line using the command <code class="highlighter-rouge">rspec</code>. <code class="highlighter-rouge">rspec</code> will also take some flags to change the output. For a full list run <code class="highlighter-rouge">rspec --help | less</code>. For example, run <code class="highlighter-rouge">rspec -c -f d</code> to see how the output differs. If you find yourself consistently using flags you can save them to a <code class="highlighter-rouge">.rspec</code> file in your home directory. See <a href="http://stackoverflow.com/questions/1819614/how-do-i-globally-configure-rspec-to-keep-the-color-and-format-specdoc-o">this</a> Stack Overflow answer for additional details.</p>

<p>Did we get what we expected? No? What’s going on here? It looks like the total that’s being reported by our test is the full total of our all the films currently in our database.</p>

<p>Run it one more time to check. Notice that the actual value that we’re getting increased? So, not only are we not testing with only the data we’re providing in the test, but on top of that, every time we run the test we’re adding new films to our development database.</p>

<p>This is not the behaviour we want. We’re polluting the database that we’re using when we browse the site locally. Wouldn’t it be better if we could run our test suite without making these changes?</p>

<p>We’re going to set an environment variable in our spec helper file and then use that variable to determine which database to use. In <code class="highlighter-rouge">spec_helper.rb</code> add the following <strong>above</strong> all the <code class="highlighter-rouge">require</code> lines:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ENV</span><span class="p">[</span><span class="s1">'RACK_ENV'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'test'</span>
</code></pre></div></div>

<p>It’s very important that this line comes before you require the environment. If you want to trace why, take a look first at line 14 in your <code class="highlighter-rouge">config/environment.rb</code> file, which should lead you to the <code class="highlighter-rouge">config/database.rb</code> file. In that file, you’ll see that the database name gets set based on the current environment.</p>

<p>One more step and then we should be in good shape. From the command line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake db:test:prepare
</code></pre></div></div>

<p>This should both create and run the migrations for a test database (you should be able to see the new file in your <code class="highlighter-rouge">db</code> directory). Now run your test again from the command line using <code class="highlighter-rouge">rspec</code>. Passing test? Great!</p>

<p>Run the test again. Failing test! Damn.</p>

<p>What’s happening here? Before we were saving new films to our development database every time we ran our test suite. Now we’re doing the same thing to our test database. What we’d like to do is to clear out our database after each test. We could create these methods in each one of our tests, but there’s a tool that will help us here: <a href="https://github.com/DatabaseCleaner/database_cleaner">Database Cleaner</a>.</p>

<p>In the test/development section of your Gemfile add the following line:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">gem</span> <span class="s1">'database_cleaner'</span>
</code></pre></div></div>

<p>Then in your spec helper, add the following after your current <code class="highlighter-rouge">require</code> lines:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'database_cleaner'</span>

<span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">strategy</span> <span class="o">=</span> <span class="ss">:truncation</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">clean</span>
  <span class="k">end</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">after</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">clean</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Save and run your tests again from the command line. Passing test? Great again!</p>

<h3 id="testing-validations">Testing Validations</h3>

<p>One thing we haven’t really worried about up to this point was whether or not a new Film had all of its pieces in place when we were saving it to the database. We want to make sure that when someone tries to save a film that they’re providing us with all the information we need. We don’t want to have someone save a film with, for example, no name.</p>

<p>Add the following test to your <code class="highlighter-rouge">film_spec</code> within the main <code class="highlighter-rouge">describe</code> block, but outside of your existing <code class="highlighter-rouge">describe '.total_sales'</code> block.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">it</span> <span class="s2">"is invalid without a title"</span> <span class="k">do</span>
    <span class="n">film</span> <span class="o">=</span> <span class="no">Film</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">year: </span><span class="mi">2012</span><span class="p">,</span> <span class="ss">box_office_sales: </span><span class="mi">3</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">film</span><span class="p">).</span><span class="nf">to_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Run your test suite from the command line with <code class="highlighter-rouge">rspec</code> and look for the new failure. The heart of this error is telling us that it expected <code class="highlighter-rouge">.valid?</code> to return false when called on our new film, and instead got true.</p>

<p>Great! It seems like this is testing what we want, but how can we actually make this pass?</p>

<h3 id="writing-validations">Writing Validations</h3>

<p>ActiveRecord actually helps us out here. Go into the <code class="highlighter-rouge">app/models/film.rb</code> model and add the following line:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
</code></pre></div></div>

<p>Run your tests again, and… passing. Great news.</p>

<h2 id="worktime">Worktime</h2>

<ul>
  <li>In pairs, add the following tests:
    <ul>
      <li>a test for the <code class="highlighter-rouge">.average_sales</code> method</li>
      <li>a test for the <code class="highlighter-rouge">.total_sales</code> method that ensures that when two directors exist, you’re able to scope <code class="highlighter-rouge">.total_sales</code> down to a single director by calling something like <code class="highlighter-rouge">Director.first.films.total_sales</code> (hint: you’ll need to create your associations in your test, and make sure that <code class="highlighter-rouge">box_office_sales</code> for the second director are not included in the <code class="highlighter-rouge">.total_sales</code> result)</li>
      <li>tests that a film cannot be created without a year or <code class="highlighter-rouge">box_office_sales</code></li>
    </ul>
  </li>
  <li>Add the validations to make the last pair of tests pass.</li>
  <li>We also likely want to make sure that we can test that the name of each of our films is <code class="highlighter-rouge">unique</code>. Write a test that would ensure we can’t create two films with the same name, and then use the ActiveRecord documentation available <a href="http://guides.rubyonrails.org/active_record_validations.html#uniqueness">here</a> to see what you could do to ensure the <code class="highlighter-rouge">uniqueness</code> of a new film.</li>
</ul>

<h2 id="other-resources">Other Resources:</h2>

<ul>
  <li><a href="http://rspec.info/documentation/">RSpec Documentation</a>: For now you’ll likely be most interested in the <code class="highlighter-rouge">rspec-core</code>, and <code class="highlighter-rouge">rspec-expectations</code> links.</li>
</ul>
:ET