I"@<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Understand when and why to use Express.js in the backend of an application</li>
  <li>Discuss how to create database migrations, seed files &amp; create/retrieve data using Sequelize</li>
</ul>

<h2 id="what-is-node">What is Node?</h2>

<p>Node is an open-source, cross platform, runtime environment that allows developers to create all kinds of server side tools and applications in JavaScript. It is intended for use outside of a browser context so the environment omits browser-specific JavaScript APIs and adds support for more traditional Operating System APIs including HTTP and file system libraries.</p>

<h2 id="what-is-express">What is Express?</h2>

<p>Express is a lightweight, un-opinionated web framework built on top of the server functionality provided by node.js. It helps to simplify and organize the server-side functionality of your application by providing abstractions over the more confusing parts of node.js, and adding helpful utilities and features. It provides mechanisms to:</p>
<ul>
  <li>Write handlers for requests with different HTTP verbs at different URL paths (routes).</li>
  <li>Integrate with ‚Äúview‚Äù rendering engines in order to generate responses by inserting data into templates.</li>
  <li>Set common web application settings like the port to use for connecting, and the location of templates that are used for rendering the response.</li>
  <li>Add additional request processing ‚Äúmiddleware‚Äù at any point within the request handling pipeline.</li>
</ul>

<h2 id="why-do-we-use-express">Why do we use Express?</h2>

<p>Think about how and why we use jQuery on the front-end. Vanilla JavaScript can be verbose and difficult to read. jQuery came along to give developers a nicer-looking syntax to perform the same operations. It was a library built to abstract the trickier parts of JavaScript and make them easier to write and work with. Express was built for very similar reasons.</p>

<p>Just like browser-based JavaScript, the syntax for using plain node.js isn‚Äôt the friendliest. Node gives you enough low-level features to build the backend of an application, but Express is a light layer built on top of Node to make these low-level features a little easier to read and write.</p>

<h2 id="advantages-of-express">Advantages of Express</h2>

<p>While node.js provides us with all of the functionality we need for our backends, writing this logic without Express is more difficult to make sense of and maintain. The two biggest advantages of Express are:</p>

<ol>
  <li>the collection of helpful utilities and conveniences that abstract away the node.js complexity. (e.g. sending a single image file in raw node.js is quite complex, but can be done in just one line with express)</li>
  <li>the ability to refactor request handlers into smaller pieces that are more modular and maintainable. (node.js, by default, requires you to create one large request handler, which makes your logic more rigid and difficult to refactor)</li>
</ol>

<h2 id="request-flow">Request Flow</h2>

<p>When we are just using node.js, the flow of a single request might look like this:</p>

<p><img src="https://raw.githubusercontent.com/turingschool/front-end-curriculum/gh-pages/assets/images/lessons/express/node-only-flow.png" alt="node only" /></p>

<p>When we add Express, there a couple of additional steps added to the flow of a request:</p>

<p><img src="https://raw.githubusercontent.com/turingschool/front-end-curriculum/gh-pages/assets/images/lessons/express/express-flow.png" alt="express flow" /></p>

<p>While the Express flow might look more complex, it actually makes the developer‚Äôs job a lot easier. In this flow, the developer is only responsible for the ‚ÄòMiddleware‚Äô part of the process. This replaces the single request handler function that you would write without Express. Writing middleware for Express is a lot easier to write and more maintainable because of the ‚ÄòExpress‚Äô step that abstracts the complex logic for us.</p>

<h2 id="routing--middleware">Routing &amp; Middleware</h2>

<p>Earlier we mentioned that with plain Node.js, you would create a single function to handle requests. This single function can get large and unwieldy as your application grows in complexity. Express provides routing methods(<code class="highlighter-rouge">.get</code>, <code class="highlighter-rouge">.post</code>, etc.) that allow you to break this single function into many smaller functions that only handle one thing at a time.</p>

<p>Express is a routing and middleware web framework that has minimal functionality of its own: An Express application is essentially a series of middleware function calls. Our code will be concerned with responding to client requests to different URLs with different methods (GET, POST, etc).</p>

<p>Let‚Äôs pick apart the structure of how we define an Express route:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello World!</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>In the above example, our express app (denoted by <code class="highlighter-rouge">app</code>), is handling a <code class="highlighter-rouge">GET</code> request to <code class="highlighter-rouge">'/'</code>. The second parameter in this call is our callback that defines how we‚Äôre actually going to handle what happens when a user makes a <code class="highlighter-rouge">GET</code> request to <code class="highlighter-rouge">'/'</code>. The callback takes two parameters: the request (<code class="highlighter-rouge">request</code>) and the response (<code class="highlighter-rouge">response</code>). In this example, our hander is simply sending back a response (<code class="highlighter-rouge">response.send</code>) with the text ‚ÄòHello World!‚Äô.</p>

<p>This pattern is exactly how we can define and handle any routes in an Express application. There are four main pieces to this code:</p>

<ul>
  <li><code class="highlighter-rouge">app</code> - the instance of our Express application</li>
  <li>a METHOD - the method specified when the request is made from the client. (e.g. <code class="highlighter-rouge">GET</code>, <code class="highlighter-rouge">POST</code>, <code class="highlighter-rouge">PUT</code>, <code class="highlighter-rouge">DELETE</code>)</li>
  <li>a PATH - the endpoint that we are requesting</li>
  <li>a HANDLER - the function we write that contains the logic for how the request should be dealt with, and what kind of response it should return</li>
</ul>

<h2 id="exploring-our-express-app">Exploring our Express App</h2>

<p>Let‚Äôs open up your <code class="highlighter-rouge">arcade</code> app that you created in your pre-work.</p>

<p>With a partner take about 10 minutes and walk through the following files and discuss what each line of code is doing:</p>
<ul>
  <li>app.js</li>
  <li>routes/api/v1/games.js</li>
</ul>

<h2 id="sequelize-and-adding-a-one-to-many-relationship">Sequelize and Adding a One to Many Relationship</h2>

<p><a href="http://docs.sequelizejs.com/manual/getting-started.html">Sequelize</a> is a promise based Object Relational Mapper (ORM). It allows us to simply interact with relational databases by abstracting away the need to use SQL directly. In the pre-work, we used Sequelize to create our database, generate a single model, run migrations, and to seed our development database. Now, we are going to look at how to set up a one-to-many relationship.</p>

<p>Let‚Äôs create a store model first.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx sequelize model:generate <span class="nt">--name</span> Store <span class="nt">--attributes</span> name:string,phoneNumber:bigint
</code></pre></div></div>

<p>Next, let‚Äôs think about the type of relationship we want to have between games and stores.
A store should have many games and a game belongs to a store. This means we need to update our games table to have a foreign key of store id. To do this we will need to generate a migration to add the store id to games.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> npx sequelize migration:generate <span class="nt">--name</span> addStoreIdToGame
</code></pre></div></div>

<p>Open up this migration and input the following:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">up</span><span class="p">:</span> <span class="p">(</span><span class="nx">queryInterface</span><span class="p">,</span> <span class="nx">Sequelize</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
       <span class="k">return</span> <span class="nx">queryInterface</span><span class="p">.</span><span class="nx">addColumn</span><span class="p">(</span>
         <span class="dl">'</span><span class="s1">Games</span><span class="dl">'</span><span class="p">,</span><span class="c1">//table we are adding the column too</span>
         <span class="dl">'</span><span class="s1">StoreId</span><span class="dl">'</span><span class="p">,</span> <span class="c1">//the foreign key that we are adding</span>
         <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
          <span class="na">references</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">model</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Stores</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// name of Target model</span>
            <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// key in Target model that we're referencing</span>
          <span class="p">},</span>
          <span class="na">onUpdate</span><span class="p">:</span> <span class="dl">'</span><span class="s1">CASCADE</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">onDelete</span><span class="p">:</span> <span class="dl">'</span><span class="s1">SET NULL</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">}</span>
       <span class="p">)</span>
  <span class="p">},</span>

  <span class="na">down</span><span class="p">:</span> <span class="p">(</span><span class="nx">queryInterface</span><span class="p">,</span> <span class="nx">Sequelize</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">queryInterface</span><span class="p">.</span><span class="nx">removeColumn</span><span class="p">(</span>
      <span class="dl">"</span><span class="s2">Games</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// name of Source model</span>
      <span class="dl">"</span><span class="s2">StoreId</span><span class="dl">"</span> <span class="c1">// key we want to remove</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p><strong>Important:</strong> The foreign key <code class="highlighter-rouge">StoreId</code> must be written in Pascal Case(both the s and i are capitalized).
Looking at <code class="highlighter-rouge">onUpdate</code> we see the value is set to <code class="highlighter-rouge">CASCADE</code>. What does this mean? This means that if we update the id of a store on the stores table it will also update foreign key of store id on the games table.
Similarly, with <code class="highlighter-rouge">onDelete</code> the value is set to <code class="highlighter-rouge">SET NUll</code>. If we delete a store, we do not want to delete the games that are associated to it, but instead set the foreign key value to <code class="highlighter-rouge">NULL</code>.</p>

<p>We‚Äôve set up our one-to-many relationship at the database level, but now we must update our game and store models to reflect these relationships too. Fortunately, that is very simple to do. Let‚Äôs start with the game model. Open up <code class="highlighter-rouge">game.js</code>. You should see:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Game</span><span class="p">.</span><span class="nx">associate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// associations can be defined here</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Replace the <code class="highlighter-rouge">associations can be defined here</code> comment with <code class="highlighter-rouge">Game.belongsTo(models.Store)</code>. So, now you should see:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Game</span><span class="p">.</span><span class="nx">associate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Game</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">Store</span><span class="p">,</span> <span class="p">{</span><span class="na">foreignKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">StoreId</span><span class="dl">'</span><span class="p">,</span> <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">store</span><span class="dl">'</span><span class="p">})</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Next add the has many to the store model. Open up <code class="highlighter-rouge">store.js</code> and update it the associate section.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Store</span><span class="p">.</span><span class="nx">associate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Store</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">Game</span><span class="p">,</span> <span class="p">{</span><span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">games</span><span class="dl">'</span><span class="p">})</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Great job! Now our associations are complete at the database and model level.</p>

<p>Since we have a seed file for our games, we will need to make adjustments to include stores and the association to stores.</p>

<p>Run <code class="highlighter-rouge">npx sequelize db:seed:undo</code></p>

<p>Now you can delete the current seed file, and generate a new one to include our our recent changes.
<em>Try it:</em> Write a seed file to generate stores and games.</p>

<h3 id="additional-crud-practice">Additional CRUD Practice</h3>

<p><em>On your own:</em> Write the CRUD routes for store.</p>
:ET