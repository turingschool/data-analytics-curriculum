I"T:<h2 id="learning-goals">Learning Goals</h2>
<ul>
  <li>Describe sad path testing, and why it is necessary</li>
  <li>Implement a sad path user story</li>
</ul>

<h2 id="vocabulary">Vocabulary</h2>
<ul>
  <li>Sad Path</li>
  <li>Flash</li>
</ul>

<h2 id="set-up">Set Up</h2>
<p>We will start from the <code class="highlighter-rouge">many_to_many</code> branch of our <a href="https://github.com/turingschool-examples/set_list/tree/many_to_many">Set List Repo</a></p>

<h2 id="warm-up">Warm Up</h2>
<ul>
  <li>As developers, how do we know when our application isn’t working properly?</li>
  <li>As a user, how do we know when we have used an application in an unintended way?</li>
</ul>

<h2 id="testing-the-sad-path">Testing the Sad Path</h2>

<p>When writing tests for our applications, we generally want to have two types of tests:</p>

<ol>
  <li>Tests for the correct usage of the application - the <strong>Happy Path</strong>. And,</li>
  <li>Tests for an incorrect usage - the <strong>Sad Path</strong>.</li>
</ol>

<p>Sad Path is really all about helping an end user have a better experience within the application.  While we can not anticipate <em>every</em> way a user might break the appropriate flow of the application, there are some areas where we can confidently say will be sticking points for users, and we can build sad path feedback around these areas.</p>

<p>Sad Path testing gives us an opportunity to improve an end-users experience by intentionally building in some application feedback to help guide a user to the correct use of the app.  For example, when a user is creating a new resource, they may not know intuitively which of the resources attributes are necessary for that record to be saved in the database.  Rather than letting the application crash in the case of a user trying to create a resource without the required information, we can build a Sad Path that will help guide them through the flow of the creation process.</p>

<p>To illustrate this concept, let’s implement the following user story in our Set List app:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>As a Visitor
I visit the new artist page
And click 'Create Artist' without filling in a name
Then I see a message telling me that I am missing required information
And I still see the new artist form
</code></pre></div></div>

<p>Before jumping in to TDD, let’s check out this functionality as a user would see it by spinning up our server locally and walking through the user story.  What happened?  Did we create an artist? Did something go wrong?  At this point, as a user, it is difficult to tell what happened.  The user sees no error (the app didn’t crash), but also doesn’t see any indication that they may have done anything wrong.</p>

<p>Let’s update our existing test for artist creation to include this corresponding test:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/features/artist/new_spec.rb</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'New Artist'</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'As a visitor'</span> <span class="k">do</span>
    <span class="n">describe</span> <span class="s1">'When I visit the new artist form by clicking a link on the index'</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">'I can create a new artist'</span> <span class="k">do</span>
        <span class="o">...</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'I can not create an artist without a name'</span> <span class="k">do</span>
        <span class="n">visit</span> <span class="s1">'/artists/new'</span>

        <span class="n">click_on</span> <span class="s1">'Create Artist'</span>

        <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">"Artist not created: Required information missing."</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_button</span><span class="p">(</span><span class="s1">'Create Artist'</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Use <code class="highlighter-rouge">binding.pry</code> in you Artists Controller see what is going on when we try to create an artist without a name:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#app/controllers/artists_controller.rb</span>

<span class="k">class</span> <span class="nc">ArtistsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="o">...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
    <span class="no">Artist</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">artist_params</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="s1">'/artists'</span>
  <span class="k">end</span>

  <span class="o">...</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">artist_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If we run this new test, we can see the output of trying to create an artist without a name:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9: def create
=&gt; 10:   binding.pry
11:   Artist.create(artist_params)
12:   redirect_to '/artists'
13: end

[1] pry(#&lt;ArtistsController&gt;)&gt; play -l 11
=&gt; #&lt;Artist:0x007fc9f512c480 id: nil, name: ""&gt;
</code></pre></div></div>

<p><code class="highlighter-rouge">play -l &lt;line_number&gt;</code> is a shortcut in pry to run a line of code. In this case, we’re running <code class="highlighter-rouge">Artist.create(artist_params)</code> in pry by telling it to run line 11. The create method gave us a return value, but the artist object it returned does not have an id - indicating that the artist was not saved in the database.  Why was the artist not saved?  Take a look back at the Artist model and see if you can spot what is causing the artist to not be saved.</p>

<p>Now that we are writing tests for our Sad Path, using <code class="highlighter-rouge">.create</code> isn’t really the best choice.  What we would like is to be able to send the user some feedback if the record is not saved in the database; so, let’s use a combination of <code class="highlighter-rouge">.new</code> and <code class="highlighter-rouge">.save</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArtistsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="o">...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">artist</span> <span class="o">=</span> <span class="no">Artist</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">artist_params</span><span class="p">)</span>
    <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
    <span class="n">artist</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">redirect_to</span> <span class="s1">'/artists'</span>
  <span class="k">end</span>

  <span class="o">...</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">artist_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, what happens when we call <code class="highlighter-rouge">artist.save</code> - a boolean!  Great, we can use this to control two paths through artist creation - one successful, one not so much.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArtistsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="o">...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">artist</span> <span class="o">=</span> <span class="no">Artist</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">artist_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artist</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">redirect_to</span> <span class="s1">'/artists'</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Artist not created: Required information missing."</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="o">...</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">artist_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s take a quick moment to talk about <strong>flash</strong> messages.  flash is an object that Rails gives us to help us send information back to a client that will be displayed to a user.  Taking a look at how the flash message is created, what data structure does it look like?  Just like params, the flash object acts just like a ruby hash!</p>

<p>But, just because we created the flash, doesn’t mean a user will automatically see it - we will need to tell our views to display the flash information:</p>

<p><code class="highlighter-rouge">app/views/layouts/application.html.erb</code></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>SetList<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">csrf_meta_tags</span> <span class="err">%</span><span class="nt">&gt;</span>
    <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">stylesheet_link_tag</span> <span class="err">"</span><span class="na">https:</span><span class="err">//</span><span class="na">stackpath.bootstrapcdn.com</span><span class="err">/</span><span class="na">bootstrap</span><span class="err">/4.3.1/</span><span class="na">css</span><span class="err">/</span><span class="na">bootstrap.min.css</span><span class="err">"%</span><span class="nt">&gt;</span>
    <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">stylesheet_link_tag</span>    <span class="err">'</span><span class="na">application</span><span class="err">',</span> <span class="na">media:</span> <span class="err">'</span><span class="na">all</span><span class="err">'</span> <span class="err">%</span><span class="nt">&gt;</span>
    <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">javascript_include_tag</span> <span class="err">'</span><span class="na">application</span><span class="err">'</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="na">flash.each</span> <span class="na">do</span> <span class="err">|</span><span class="na">type</span><span class="err">,</span> <span class="na">message</span><span class="err">|</span> <span class="err">%</span><span class="nt">&gt;</span>
      <span class="nt">&lt;p&gt;&lt;</span><span class="err">%=</span> <span class="na">message</span> <span class="err">%</span><span class="nt">&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="na">end</span> <span class="err">%</span><span class="nt">&gt;</span>

    <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">yield</span> <span class="err">%</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Since our flash object is a collection of key/value pairs, we can iterate over any flashes that may exist, and display their message to a user!</p>

<p>Now, let’s jump back to our artists controller - what’s the deal with <code class="highlighter-rouge">render :new</code>?  We can use the <code class="highlighter-rouge">render</code> method anytime we want to override the default view in a rails controller action.  In this case, when an artist is not created, we want to respond to the client with the new form, rather than telling it to redirect to another action.</p>

<h2 id="you-do">You Do</h2>
<ul>
  <li>Write a test that uses a <code class="highlighter-rouge">within</code> block to test that a flash message is appearing when a user goes down a sad path in your project.</li>
  <li>Use validations to display the errors attached to the model for a specific attribute in your flash message.</li>
  <li>Think about how you could DRY this up</li>
  <li>Read the <a href="https://guides.rubyonrails.org/action_controller_overview.html#the-flash">Guides on flash messages</a></li>
  <li>Read <a href="https://www.rubyguides.com/2019/11/rails-flash-messages/">this blog post on the flash</a></li>
  <li>Style your flash</li>
</ul>

<h2 id="checks-for-understanding">Checks for Understanding</h2>

<ol>
  <li>What is an example of a Sad Path - how does it differ from a Happy Path?</li>
  <li>When we create a flash message, what changes do we need to make in our views?</li>
  <li>How do you override the default view in Rails?</li>
</ol>
:ET