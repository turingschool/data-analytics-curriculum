I"+º<h2 id="agenda">Agenda</h2>

<ul>
  <li>Background</li>
  <li>Starting a Server</li>
  <li>Reading the Request</li>
  <li>Generating the Response</li>
  <li>Playing the game (query params)</li>
  <li>Refactor (into methods)</li>
  <li>Form Data</li>
  <li>Refactor (into responsibilities)</li>
</ul>

<h2 id="background">Background</h2>

<p>The internet, which for most people is the web‚Ä¶how does that work?</p>

<ul>
  <li>The <strong>Internet</strong> is the network between devices that allows them to exchange information</li>
  <li>Devices fall in to two categories: <strong>Clients</strong> and <strong>Servers</strong>.</li>
  <li>Clients send <strong>Requests</strong> to Servers asking for some kind of information</li>
  <li>Upon receiving a Request, Servers send <strong>Responses</strong> back to the Client</li>
</ul>

<p><strong>HTTP</strong> is a set of rules for how this exchange of information happens. Clients and Servers adhere to these rules to ensure that they understand each other‚Äôs Requests and Responses.</p>

<p>Imagine you‚Äôre writing to a penpal. The process would look something like this:</p>

<ol>
  <li>Write a letter</li>
  <li>Specify your penpal‚Äôs address</li>
  <li>Drop the letter in your mailbox</li>
  <li>The letter goes through the postal system and arrives at your penpal‚Äôs mailbox</li>
</ol>

<p>Your penpal then goes through a very similar set of steps:</p>

<ol>
  <li>Read your letter and write a response</li>
  <li>Specify your address</li>
  <li>Drop their letter in their mailbox</li>
  <li>The letter goes through the postal system and arrives at your mailbox</li>
</ol>

<p>In this metaphor:</p>

<ul>
  <li>You are the <strong>Client</strong></li>
  <li>Your penpal is the <strong>Server</strong></li>
  <li>Your letter is the <strong>Request</strong></li>
  <li>Your penpal‚Äôs letter is the <strong>Response</strong></li>
  <li>The postal system, the thing responsible for ensuring your letters are delivered, is <strong>The Internet</strong></li>
</ul>

<p><strong>HTTP</strong> is the language you write in so that your penpal can understand you. You may write in English because you know you both understand English. If you wrote a letter in Spanish and your penpal only spoke English, they might write you a letter back saying ‚ÄúPlease write to me in English‚Äù.</p>

<p>Metaphor aside, let‚Äôs run through the protocol as executed by computers:</p>

<ol>
  <li>You open your browser, the Client, and type in a web address like <code class="highlighter-rouge">http://turing.io</code> and hit enter.</li>
  <li>The browser takes this address and builds an <strong>HTTP Request</strong>. It addresses it to the Server located at <code class="highlighter-rouge">http://turing.io</code>.</li>
  <li>The Request is handed off to your Internet Service Provider (ISP) (like CenturyLink or Comcast) and they send it through the Internet, mostly a series of wires and fiber optic cables, to the Server</li>
  <li>The Server reads the Request. It knows how to read it because it is formatted as an <strong>HTTP Request</strong>.</li>
  <li>The Server generates an <strong>HTTP Response</strong> to that Request.</li>
  <li>The server hands the Response off to their ISP and it goes through the internet to arrive at your computer.</li>
  <li>Your browser reads the Response. It knows how to read it because it is formatted as an <strong>HTTP Response</strong>.</li>
  <li>Your browser displays the data on your machine.</li>
</ol>

<p>That‚Äôs HTTP. At its core, it is a bunch of formatting rules that Clients and Servers use to talk to each other. You can read more on the <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">wikipedia page</a> or the <a href="https://tools.ietf.org/html/rfc2616">IETF specification</a>.</p>

<h3 id="the-request">The Request</h3>

<p>When you enter <code class="highlighter-rouge">localhost:9292</code> into your address bar, your browser will build an HTTP Request. Here is what an actual request looks like. Note that it‚Äôs just a single highly-formatted string:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1
Host: 127.0.0.1:9292
Connection: keep-alive
Cache-Control: max-age=0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36
Accept-Encoding: gzip, deflate, sdch
Accept-Language: en-US,en;q=0.8
</code></pre></div></div>

<p>The parts we‚Äôre most interested in are:</p>

<ul>
  <li>The first line, <code class="highlighter-rouge">GET / HTTP/1.1</code>, which specifies the <em>verb</em>, <em>path</em>, and <em>protocol</em> which we‚Äôll pick apart later</li>
  <li><code class="highlighter-rouge">Host</code> which is where the request is sent to</li>
  <li><code class="highlighter-rouge">Accept</code> which specifies what format of data the client wants back in the response</li>
</ul>

<p>With those pieces of information a typical server can generate a response.</p>

<h3 id="the-response">The Response</h3>

<p>The Server generates and transmits a response that looks like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http/1.1 200 ok
date: Sun,  1 Nov 2015 17:25:48 -0700
server: ruby
content-type: text/html; charset=iso-8859-1
content-length: 27

The response body goes here
</code></pre></div></div>

<p>The parts we‚Äôre most interested in are:</p>

<ul>
  <li>The first line, <code class="highlighter-rouge">HTTP/1.1 200 ok</code>, which has the <em>protocol</em> and the <em>response code</em></li>
  <li>The unmarked lines at the end which make up the <em>body</em> of the response</li>
  <li><code class="highlighter-rouge">content-length</code> which tells the client when to stop listening</li>
</ul>

<h2 id="starting-a-server">Starting a Server</h2>

<p>In this tutorial, we will play the part of both the Server and Client. We will write the server in Ruby, and we will use a web browser, like Chrome or Safari, as the Client.</p>

<p>Add the following lines of code to a Ruby file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>
</code></pre></div></div>

<p>Run the file with <code class="highlighter-rouge">Ruby &lt;filename&gt;</code> and you should see that nothing happens. So what do these lines of code do?</p>

<p>TCPServer is the Class we will use to create a new Server.</p>

<p>9292 is the <strong>Port</strong> that the Server runs on. The Port uniquely identifies a program running on a computer. Back to our penpal analogy, imagine your penpal lives in a large apartment building. You have to specify both the street address and the apartment number. In HTTP, we have to specify both the Server and the program within the Server we want to send our Request to.</p>

<p>Nothing is special about the Port we specified, 9292. It is just a number. You could just as easily change this number to 8181.</p>

<p>Update the file like so:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="c1"># Wait for a Request</span>
<span class="c1"># When a request comes in, save the connection to a variable</span>
<span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>
</code></pre></div></div>

<p>The last line is telling the server to wait for a Request. When our server gets a Request, we are saving the connection to a variable called <code class="highlighter-rouge">connection</code>. This connection is an open door between our Server and Client that the Server will use to read the Request and send back the Response. If you run the file now, you should see <code class="highlighter-rouge">Waiting for Request...</code> printed to your terminal which then hangs. Success! Your Server is now running. Use <code class="highlighter-rouge">ctrl + c</code> to stop the Server.</p>

<h2 id="address-in-use-errors">Address In Use Errors</h2>

<p><code class="highlighter-rouge">ctrl + c</code> gracefully ends our program, but sometimes things happen that make our program exit not so gracefully. One of these things is using <code class="highlighter-rouge">ctrl + z</code>. <strong>DO NOT</strong> use <code class="highlighter-rouge">ctrl + z</code>! This could result in the Port not being released, and you may at some point see an error like this:</p>

<p><code class="highlighter-rouge">Address already in use - bind(2) for nil port 9292 (Errno::EADDRINUSE)</code></p>

<p>If you get that error enter this command into your terminal:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsof -i:9292
</code></pre></div></div>

<p>and you should get output that looks like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COMMAND   PID  USER       FD   TYPE            DEVICE SIZE/OFF NODE NAME
ruby    63015 username    8u  IPv6  0xc5b438446726a53      0t0  TCP *:armtechdaemon (LISTEN)
</code></pre></div></div>

<p>Take that number under <code class="highlighter-rouge">PID</code>, in this case 63015, and enter:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kill -9 63015
</code></pre></div></div>

<p>Run your server file again and everything should be okay.</p>

<h2 id="reading-the-request">Reading the Request</h2>

<p>Update your file to look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="c1"># Wait for a Request</span>
<span class="c1"># When a request comes in, save the connection to a variable</span>
<span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>

<span class="c1"># Read the request line by line until we have read every line</span>
<span class="nb">puts</span> <span class="s2">"Got this Request:"</span>
<span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">end</span>

<span class="c1"># Print out the Request</span>
<span class="nb">puts</span> <span class="n">request_lines</span>
</code></pre></div></div>

<p>Run your file again and you should see your terminal hanging. Open up a web browser, like Google Chrome, and enter the following into the address bar:</p>

<p><code class="highlighter-rouge">localhost:9292</code></p>

<p>Your terminal should print out the Request text similar to the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1
Host: localhost:9292
Connection: keep-alive
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
</code></pre></div></div>

<p><strong>Note:</strong> If you are using Google Chrome, it may send two requests. The first one is the one we are concerned with. Ignore the second one requesting the ‚Äúfavicon‚Äù.</p>

<p>What we just did was start a Server and tell it to wait for a Request. Then we sent a Request using a web browser. When our Server got the Request, it read it and printed it out to the screen line by line.</p>

<p>What got printed to the screen is the <strong>HTTP Request</strong>. It is just a highly formatted string. Let‚Äôs break down this Request:</p>

<p>The first line is called the <strong>Request Line</strong>. It contains:</p>

<ul>
  <li>The <strong>Verb</strong>, in this case <code class="highlighter-rouge">GET</code>. The Verb indicates what type of Request are you sending. <code class="highlighter-rouge">GET</code> is the most basic HTTP Verb. A Get Request is just asking for information.</li>
  <li>The <strong>Path</strong>, in this case <code class="highlighter-rouge">/</code>. The Path specifies where the request should go. Together, the first two words are saying ‚ÄúGet me the information located at <code class="highlighter-rouge">/</code>‚Äù.</li>
  <li>The Protocol, in this case <code class="highlighter-rouge">HTTP/1.1</code>. It specifies which version of the HTTP protocol we are using.</li>
</ul>

<p>All of the following lines are <strong>Headers</strong>. The first word is the name of the Header, and everything after is the value of the Header. The first Header is the <code class="highlighter-rouge">host</code> header that has a value of <code class="highlighter-rouge">localhost:9292</code>. Notice that this is very similar to a Hash.</p>

<h3 id="generating-the-response">Generating the Response</h3>

<p>Now that our Server has gotten a Request, we need to send back a Response. Update your file with the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="c1"># Wait for a Request</span>
<span class="c1"># When a request comes in, save the connection to a variable</span>
<span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>

<span class="c1"># Read the request line by line until we have read every line</span>
<span class="nb">puts</span> <span class="s2">"Got this Request:"</span>
<span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
<span class="k">end</span>

<span class="c1"># Print out the Request</span>
<span class="nb">puts</span> <span class="n">request_lines</span>

<span class="c1"># Generate the Response</span>
<span class="nb">puts</span> <span class="s2">"Sending response."</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Hello from the Server side!&lt;/html&gt;"</span>
<span class="n">status</span> <span class="o">=</span> <span class="s2">"http/1.1 200 ok"</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">output</span>

<span class="c1"># Send the Response</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span>

<span class="c1"># close the connection</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">close</span>
</code></pre></div></div>

<p>Run this file and send a Request to <code class="highlighter-rouge">localhost:9292</code> from the browser just like before. You should see the text <code class="highlighter-rouge">Hello from the Server side</code> in your browser. We now have a successful Client/Server interaction!</p>

<p>Let‚Äôs break down our response:</p>

<p>The variable <code class="highlighter-rouge">output</code> is the information we want to send to the Client. In our case, it is some HTML with a short message.</p>

<p>The variable <code class="highlighter-rouge">status</code> is required by the HTTP protocol. It indicates what the result of the request was. <code class="highlighter-rouge">200 ok</code> is the most common status. It means everything is fine. Another common status you‚Äôve probably seen is <code class="highlighter-rouge">404 not found</code>. There are many, many different HTTP status codes.</p>

<p>Together, the <code class="highlighter-rouge">status</code> and <code class="highlighter-rouge">output</code> make the request. Notice there needs to be two <code class="highlighter-rouge">\r\n</code>s joining the status and the output. These blank lines are an example of how the HTTP Request needs to be formatted properly so that our Client can read it. Try just putting one <code class="highlighter-rouge">\r\n</code> in between them and see what happens.</p>

<p>When we are done writing the Response, we need to close the connection.</p>

<p>After your Server sends a response, the program ends. If you try to send to refresh the page, you won‚Äôt get a connection. Let‚Äôs update our code so that the Server will continually accept Requests:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="kp">loop</span> <span class="k">do</span>
  <span class="c1"># Wait for a Request</span>
  <span class="c1"># When a request comes in, save the connection to a variable</span>
  <span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>

  <span class="c1"># Read the request line by line until we have read every line</span>
  <span class="nb">puts</span> <span class="s2">"Got this Request:"</span>
  <span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="k">end</span>

  <span class="c1"># Print out the Request</span>
  <span class="nb">puts</span> <span class="n">request_lines</span>

  <span class="c1"># Generate the Response</span>
  <span class="nb">puts</span> <span class="s2">"Sending response."</span>
  <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Hello from the Server side!&lt;/html&gt;"</span>
  <span class="n">status</span> <span class="o">=</span> <span class="s2">"http/1.1 200 ok"</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">output</span>

  <span class="c1"># Send the Response</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span>

  <span class="c1"># close the connection</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You should now be able to refresh the page multiple times and get a Response every time.</p>

<h2 id="playing-the-guessing-game">Playing the Guessing Game</h2>

<p>Now we want to use our server to play a number guessing game. In order to make this work, we can‚Äôt just request information from the Server. We have to also send it some information, in this case the guess. We do that with parameters. Parameters are extra information attached to the Path Header. They are specified using the <code class="highlighter-rouge">?</code>. We want to be able to send a guess like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>localhost:9292?guess=50
</code></pre></div></div>

<p>When your server gets a Request like this, it will see the Path as <code class="highlighter-rouge">/?guess=50</code>. We need to extract the guess and report back whether the guess was correct, too low, or too high.</p>

<p>Update your code with the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="n">answer</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">100</span><span class="p">)</span>
<span class="n">guess</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="c1"># Create a new instance of TCPServer on Port 9292</span>
<span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

<span class="kp">loop</span> <span class="k">do</span>
  <span class="c1"># Wait for a Request</span>
  <span class="c1"># When a request comes in, save the connection to a variable</span>
  <span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>

  <span class="c1"># Read the request line by line until we have read every line</span>
  <span class="nb">puts</span> <span class="s2">"Got this Request:"</span>
  <span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="k">end</span>

  <span class="c1"># Print out the Request</span>
  <span class="nb">puts</span> <span class="n">request_lines</span>

  <span class="c1"># Extract the guess parameter if the Request included a guess</span>
  <span class="n">request_line</span> <span class="o">=</span> <span class="n">request_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">request_line</span><span class="p">.</span><span class="nf">include?</span> <span class="s1">'?'</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">request_line</span><span class="p">.</span><span class="nf">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"guess="</span><span class="p">)</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_i</span>
  <span class="k">end</span>

  <span class="c1"># Generate the Response</span>
  <span class="nb">puts</span> <span class="s2">"Sending response."</span>
  <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">answer</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was too low&lt;/html&gt;"</span>
  <span class="k">elsif</span> <span class="n">guess</span> <span class="o">&gt;</span> <span class="n">answer</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was too high&lt;/html&gt;"</span>
  <span class="k">else</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was Correct!&lt;/html&gt;"</span>
  <span class="k">end</span>
  <span class="n">status</span> <span class="o">=</span> <span class="s2">"http/1.1 200 ok"</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">output</span>

  <span class="c1"># Send the Response</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span>

  <span class="c1"># close the connection</span>
  <span class="n">connection</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Go to your browser and enter <code class="highlighter-rouge">localhost:9292?guess=50</code>. You should now be playing the guessing game. Have fun!</p>

<h2 id="refactor">Refactor</h2>

<p>At this point, we have a functioning game, but it could use a refactor. We‚Äôre going to take a second to refactor:</p>

<p>Start with this file and implement the empty method. If working, you should be able to run your server and play the guessing game just like before.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Library that contains TCPServer</span>
<span class="nb">require</span> <span class="s1">'socket'</span>
<span class="nb">require</span> <span class="s1">'pry'</span>

<span class="k">def</span> <span class="nf">start</span>
 <span class="n">answer</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">100</span><span class="p">)</span>
 <span class="n">guess</span> <span class="o">=</span> <span class="kp">nil</span>
 <span class="c1"># Create a new instance of TCPServer on Port 9292</span>

 <span class="n">server</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">9292</span><span class="p">)</span>

 <span class="kp">loop</span> <span class="k">do</span>
   <span class="c1"># Wait for a Request</span>
   <span class="c1"># When a request comes in, save the connection to a variable</span>
   <span class="nb">puts</span> <span class="s1">'Waiting for Request...'</span>
   <span class="n">connection</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span>
   <span class="n">request_lines</span> <span class="o">=</span> <span class="n">read_request</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

   <span class="c1"># Read the request line by line until we have read every line</span>
   <span class="nb">puts</span> <span class="s2">"Got this Request:"</span>

   <span class="c1"># Print out the Request</span>
   <span class="nb">puts</span> <span class="n">request_lines</span>

   <span class="c1"># Break apart the request</span>
   <span class="n">parsed_request</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request_lines</span><span class="p">)</span>
   <span class="n">verb</span> <span class="o">=</span> <span class="n">parsed_request</span><span class="p">[</span><span class="s2">"verb"</span><span class="p">]</span>
   <span class="n">path</span> <span class="o">=</span> <span class="n">parsed_request</span><span class="p">[</span><span class="s2">"path"</span><span class="p">]</span>
   <span class="n">query_params</span> <span class="o">=</span> <span class="n">parsed_request</span><span class="p">[</span><span class="s2">"query_params"</span><span class="p">]</span>

   <span class="n">guess</span> <span class="o">=</span> <span class="n">extract_guess</span><span class="p">(</span><span class="n">query_params</span><span class="p">)</span>

   <span class="c1"># Generate the Response</span>

   <span class="n">response</span> <span class="o">=</span> <span class="n">generate_response</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

   <span class="c1"># Send the Response</span>
   <span class="nb">puts</span> <span class="s2">"Sending response."</span>
   <span class="n">connection</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span>

   <span class="c1"># close the connection</span>
   <span class="n">connection</span><span class="p">.</span><span class="nf">close</span>
 <span class="k">end</span>
<span class="k">end</span>



<span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="n">request_lines</span><span class="p">)</span>
 <span class="c1"># This method should take the lines of the request as input and return a hash with the request verb, path, query params, version, and headers. For example:</span>
 <span class="c1"># {</span>
 <span class="c1">#   "verb" =&gt; "GET",</span>
 <span class="c1">#   "path" =&gt; "/",</span>
 <span class="c1">#   "version" =&gt; "HTTP/1.1",</span>
 <span class="c1">#   "query_params" =&gt; "guess=50",</span>
 <span class="c1">#   "Host" =&gt; "localhost:9292",</span>
 <span class="c1">#   "Connection" =&gt; "keep-alive",</span>
 <span class="c1">#   "User-Agent" =&gt; "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36",</span>
 <span class="c1">#   "Accept" =&gt; "image/webp,image/apng,image/*,*/*;q=0.8",</span>
 <span class="c1">#   "Referer" =&gt; "http://localhost:9292/",</span>
 <span class="c1">#   "Accept-Encoding" =&gt; "gzip, deflate, br",</span>
 <span class="c1">#   "Accept-Language" =&gt; "en-US,en;q=0.9,la;q=0.8"</span>
 <span class="c1"># }</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">read_request</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
 <span class="n">request_lines</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
 <span class="k">while</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">empty?</span>
   <span class="n">request_lines</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
   <span class="n">line</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">gets</span><span class="p">.</span><span class="nf">chomp</span>
 <span class="k">end</span>
 <span class="n">request_lines</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">answer</span>
   <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was too low&lt;/html&gt;"</span>
 <span class="k">elsif</span> <span class="n">guess</span> <span class="o">&gt;</span> <span class="n">answer</span>
   <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was too high&lt;/html&gt;"</span>
 <span class="k">else</span>
   <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was Correct!&lt;/html&gt;"</span>
 <span class="k">end</span>
 <span class="n">status</span> <span class="o">=</span> <span class="s2">"http/1.1 200 ok"</span>
 <span class="n">status</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">output</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">extract_guess</span><span class="p">(</span><span class="n">query_params</span><span class="p">)</span>
 <span class="n">query_params</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"="</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">to_i</span> <span class="k">if</span> <span class="n">query_params</span>
<span class="k">end</span>

<span class="n">start</span>
</code></pre></div></div>

<h2 id="form-data">Form Data</h2>

<p>This is great! :) There‚Äôs just one problem though‚Ä¶ if we were going to deploy this game, we would not expect our end users to send guesses by manually typing a guess into the query params.  Think about how a user might want to play this game.  It makes sense at this point to give them a form that they can use to submit guesses - a much friendlier user experience.</p>

<p>What we‚Äôll do next is add some logic to our <code class="highlighter-rouge">generate_response</code>. If we don‚Äôt get a guess, we‚Äôll send the user a form to input the guess in place of showing a welcome message.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">guess</span><span class="p">.</span><span class="nf">nil?</span>
   <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;
               &lt;form action='/'&gt;
                   Guess:&lt;br&gt;
                   &lt;input type='text' name='guess' &gt;&lt;br&gt;
                   &lt;input type='submit' value='Guess!'&gt;
               &lt;/form&gt;
             &lt;/html&gt;"</span>
 <span class="k">elsif</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">answer</span>
   <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was too low&lt;/html&gt;"</span>
 <span class="k">elsif</span> <span class="n">guess</span> <span class="o">&gt;</span> <span class="n">answer</span>
   <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was too high&lt;/html&gt;"</span>
 <span class="k">else</span>
   <span class="n">output</span> <span class="o">=</span> <span class="s2">"&lt;html&gt;Your Guess of </span><span class="si">#{</span><span class="n">guess</span><span class="si">}</span><span class="s2"> was Correct!&lt;/html&gt;"</span>
 <span class="k">end</span>
 <span class="n">status</span> <span class="o">=</span> <span class="s2">"http/1.1 200 ok"</span>
 <span class="n">status</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">output</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In your browser, navigate to <code class="highlighter-rouge">localhost:9292</code> and you should see your form! Type in a guess, click the button, and what happens? Everything should be working just like before! If you look in the address bar, you should see your guess being generated as a query param. By default, an HTML form will take each input (except for the submit) and generate a corresponding query param in a GET request.</p>

<p>This behavior is different than what we see with forms in Rails apps. Rails forms, and most forms on the internet, will generate POST requests and send the data in the request <strong>body</strong> rather than query params. Let‚Äôs change our form method to see that in action:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s1">'/'</span><span class="p">,</span> <span class="nb">method</span><span class="o">=</span><span class="s1">'post'</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Try to submit your form again. What happens?</p>

<p>Try to put a <code class="highlighter-rouge">binding.pry</code> after you read the request:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_request</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request_lines</span><span class="p">)</span>
<span class="n">verb</span> <span class="o">=</span> <span class="n">parsed_request</span><span class="p">[</span><span class="s2">"verb"</span><span class="p">]</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">parsed_request</span><span class="p">[</span><span class="s2">"path"</span><span class="p">]</span>
<span class="n">query_params</span> <span class="o">=</span> <span class="n">parsed_request</span><span class="p">[</span><span class="s2">"query_params"</span><span class="p">]</span>

<span class="n">guess</span> <span class="o">=</span> <span class="n">extract_guess</span><span class="p">(</span><span class="n">query_params</span><span class="p">)</span>

<span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
</code></pre></div></div>

<p>In HTTP requests, the post data appears in the <strong>body</strong> of the request after the headers. A blank line indicates the end of the headers and the beginning of the body. If you look at the <code class="highlighter-rouge">read_request</code> method, right now we stop reading the request once we hit that first blank line.</p>

<p>In your pry session, try to read some more data from the client:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">connection</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>If you enter this command multiple times, you should see your post data being read from the request body character by character (this is what the <code class="highlighter-rouge">(1)</code> indicates). What happens if you continue to enter that command after all the data is read?</p>

<p>The problem with this approach is that we need to read the <em>exact</em> length of the data the client sends, otherwise we‚Äôll be trying to read data that isn‚Äôt there, and our connection will hang.</p>

<p>To solve this problem, the client will send a header called <code class="highlighter-rouge">Content-Length</code> to indicate how much data they sent in the body. In your <code class="highlighter-rouge">pry</code> session, see if you can access this header.</p>

<p>Now that we have the information we need to read the body, we need to figure out how to determine if the guess was sent via a form or through query params. What information are we already capturing that can help us make this decision?</p>

<p>See if you can use this information to read the request body (if necessary) and pass the appropriate information to the <code class="highlighter-rouge">generate_response</code> method.</p>

<h2 id="redirects">Redirects</h2>

<p>A <a href="https://en.wikipedia.org/wiki/URL_redirection">Redirect</a> is a special kind of HTTP response. It indicates to an HTTP client that the resource they requested should be fetched from a different location. A redirect is HTTP‚Äôs mechanism of telling a client (often a web browser) to ‚Äúgo over there.‚Äù You‚Äôve seen this on the web whenever you submit a web form and your browser automatically loads a new page. Redirects are often used in response to POST requests.</p>

<p>To respond with a redirect, you need to send 2 things:</p>

<ol>
  <li>A <code class="highlighter-rouge">3xx</code> status code ‚Äì in our case <code class="highlighter-rouge">301</code> will be the standard status code for redirecting</li>
  <li>A special header called <code class="highlighter-rouge">Location</code> ‚Äì the <code class="highlighter-rouge">Location</code> header indicates the new URL the browser should visit. For example the header <code class="highlighter-rouge">Location: http://google.com</code> would tell a web browser to navigate to google‚Äôs homepage.</li>
</ol>

<p>Here‚Äôs what the headers for an example redirect response would look like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -I google.com
HTTP/1.1 301 Moved Permanently
Location: http://www.google.com/
Content-Type: text/html; charset=UTF-8
Date: Fri, 26 Feb 2016 01:55:24 GMT
Expires: Sun, 27 Mar 2016 01:55:24 GMT
Cache-Control: public, max-age=2592000
Server: gws
Content-Length: 219
X-XSS-Protection: 1; mode=block
X-Frame-Options: SAMEORIGIN
</code></pre></div></div>

<p>Add functionality to your app to redirect the user to a special Congratulations page when they guess the correct answer. For example, your redirect can send them to <code class="highlighter-rouge">/congrats</code>.</p>

<h2 id="cookies">Cookies</h2>

<p>Right now, every user who visits our app will have the same number they are guessing. For example, if you open up two browsers (like Chrome and Safari), and play the game, you‚Äôll notice you‚Äôll be playing the same game on both of them.</p>

<p>We can store information for each client in the client‚Äôs cookies. See if you can update your app to give each client a different number they are guessing. See <a href="https://stackoverflow.com/questions/3467114/how-are-cookies-passed-in-the-http-protocol">this Stack Overflow post</a> for some more info on setting cookies.</p>

<h2 id="refactor-1">Refactor</h2>

<p>Now that we have multiple path/verb combinations implemented, let‚Äôs refactor our app to be more generalized. We‚Äôll leave this up to you to decide what direction you take it, but here are some suggestions:</p>

<ul>
  <li>Make a separate method for each type of response</li>
  <li>Make a method that takes a verb/path combo and routes it to the appropriate response method.</li>
  <li>Make request/response objects.</li>
</ul>

<h2 id="checks-for-understanding">Checks for Understanding</h2>

<ul>
  <li>What information is included in a request and in a response?  What is the format of this information?</li>
  <li>Thinking about the Rails apps that you have built - can you label the methods and code that we created today with the Rails tools that accomplishes the same goal?</li>
  <li>What are query params and how are they sent in a request?</li>
  <li>What type of requests typically contain a body? How do we access information in that body?</li>
  <li>When a redirect response is sent, what does that tell a client? Or, how does a client handle that response?</li>
</ul>
:ET