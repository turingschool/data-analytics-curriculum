I"∫<p>This lesson plan was last tested to work with Rails 5.2.4.3 and Ruby 2.5.3</p>

<h2 id="historical-context-for-this-lesson-plan">Historical Context for this lesson plan</h2>

<p>We used to teach this class using a gem since that‚Äôs how most of us do it on the job. We saw a big difference in understanding for students who were able to hand roll the handshake and those that used a gem. The other interesting thing we uncovered was many students struggled troubleshooting the gem if they didn‚Äôt understand the process. This lesson is built showing how to hand roll the OAuth process. The expectation students should try to use a gem on their projects. The big reason for using a gem is it‚Äôs much easier to test and most struggle with testing external APIs.</p>

<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Explain the tradeoffs of using OAuth vs. building authentication from scratch.</li>
  <li>Implement the OAuth handshake using an HTTP library.</li>
  <li>Understand the value of using Omniauth to handle this handshake.</li>
  <li>Understand where to store and how to use a user‚Äôs access token</li>
</ul>

<h2 id="slides">Slides</h2>

<p>Available <a href="../slides/oauth">here</a></p>

<h2 id="prework">Prework</h2>

<p>Start by watching this <a href="https://www.youtube.com/watch?v=tFYrq3d54Dc">video</a>. Which explains the oauth process at a high level.</p>

<p>Then watch this <a href="https://vimeo.com/173947281">video</a> which actually demonstrates the process live with Github.</p>

<p>Then draw a diagram of the OAuth handshaking process that takes place between your app and and an external API (Twitter, Facebook, Github etc)</p>

<h2 id="discussion--all-about-oauth">Discussion ‚Äì All about OAuth</h2>

<h3 id="benefits-of-oauth">Benefits of OAuth</h3>

<p>There are a lot of potential advantages to outsourcing our Authentication
via Oauth.</p>

<p><strong>Removing Security Complexities</strong></p>

<p>Authentication is a tricky problem with a high cost of failure. It can often be tedious
to re-implement on one application after another, but any small mistake
can still have dire consequences.</p>

<p>With OAuth, the user never has to provide sensitive credentials to our application.
Instead, they send these details to the OAuth provider (e.g. Google), who sends
us an authentication token and some basic details on the user‚Äôs behalf.</p>

<p>Since the provider stores the user‚Äôs actual credentials, we no longer have to worry about the
security considerations of storing and encrypting user passwords.</p>

<p><strong>Service Authorization / Authentication</strong></p>

<p>Another benefit of having users authenticate with OAuth is that it gives us
authenticated access (on their behalf) to any APIs available from the OAuth
provider. API Providers frequently limit your access to their platform, and
having a user authenticate with the provider can get you access to more
resources or to an additional volume of requests.</p>

<p>This can be a big help with API rate limiting, for example, since each authenticated user will usually
be allowed their own supply of requests.</p>

<h3 id="disadvantages-of-oauth">Disadvantages of OAuth</h3>

<p>Like everything in technology, using OAuth isn‚Äôt without tradeoffs. Often the benefits
outweigh the costs, but let‚Äôs look at a few things to be aware of.</p>

<p><strong>Loss of Control</strong></p>

<p>With OAuth, we‚Äôre no longer entirely in control of the user‚Äôs login process. We
might like to collect additional information in the signup process that the
3rd party doesn‚Äôt provide to us, or design our own onboarding flow, but with OAuth
we‚Äôll be locked into whatever our provider makes available.</p>

<p><strong>Account Requirement</strong></p>

<p>This one may seem obvious, but if we‚Äôre using OAuth with twitter, then our users
will be required to have a twitter account in order to use the app. Many services
are so ubiquitous these days that this may not be a large disadvantage, but it is
something to be aware of.</p>

<p>Particularly, we may want to consider our target userbase when determining which
OAuth provider to rely on. If your app is a hip social network for tweens, requiring
users to log in with LinkedIn may not be the best choice.</p>

<p><strong>Data Duplication</strong></p>

<p>One challenge OAuth imposes on our application design is deciding how much data
to copy from the external service and where to store it. Do we duplicate the user‚Äôs
basic profile info into a table in our own DB? Or just read it from the API whenever
we need it? These types of dilemmas are very common when dealing with remote data, and
OAuth data is no exception.</p>

<h3 id="real-world-example">Real World Example</h3>

<p><strong>Applying for a Passport</strong></p>

<p>Think about the steps it takes to obtain a <a href="https://travel.state.gov/content/travel/en/passports/need-passport/apply-in-person.html">passport</a>.
You can‚Äôt just sign a form and be on your way.
You have to fill out a form, provide proof of citizenship, provide a form of identification,
AND provide a photo.</p>

<p>OAuth is very similar in that it also asks you to provide multiple forms of identification.
Simply signing into the app isn‚Äôt enough.</p>

<p><strong>Talk through the steps</strong></p>

<p>You can also visit the GitHub docs <a href="https://docs.github.com/en/developers/apps/authorizing-oauth-apps">here</a> to see the steps you need to take.</p>

<ol>
  <li>User needs to go to the github authentication site and ask for what they want.
We do this by redirecting our user to:
<code class="highlighter-rouge">https://github.com/login/oauth/authorize</code> and including in the params the
following:
    <ul>
      <li><code class="highlighter-rouge">client_id</code>: given to us when we registered our app on GitHub</li>
      <li><code class="highlighter-rouge">redirect_uri</code>: we used <code class="highlighter-rouge">https://localhost:3000/auth/github/callback</code> when we
registered our app</li>
      <li><code class="highlighter-rouge">scope</code>: list of scopes are found <a href="https://docs.github.com/en/developers/apps/scopes-for-oauth-apps">here</a></li>
    </ul>
  </li>
  <li>User needs to get authorized by signing into Github and confirming they are
who they say they are</li>
  <li>Once the user is signed in, they need to authorize the application to use the Github data.</li>
  <li>Github sends a request to our <code class="highlighter-rouge">redirect_uri</code> we provided, and includes a code
in the params</li>
  <li>We now take the code and send a POST request to
<code class="highlighter-rouge">https://github.com/login/oauth/access_token</code> and include the code in the params</li>
  <li>Github gives us an <code class="highlighter-rouge">access_token</code> associated with that user and we can use it to get information
from the API about the user.</li>
</ol>

<h2 id="workshop--implementing-oauth-with-github">Workshop ‚Äì Implementing OAuth with GitHub</h2>

<p>Let‚Äôs get some practice with handrolling OAuth by implementing it in a simple
Rails project. While there are gems we can use for OAuth, handrolling will
allow us to understand what is going on behind the scenes.</p>

<p>Note: We are going to be implementing all of the code in the Sessions Controller #create method.
We do this in the tutorial so it is easier to understand what is happening. It is
greatly recommended that you refactor the code out once you have your code working.</p>

<h3 id="step-1---registering-with-the-provider">Step 1 - Registering with the Provider</h3>

<p>For this exercise, we‚Äôll be authenticating with Github. As a first step,
we need to register an application with Github, which will allow us
to obtain the credentials we‚Äôll need in order for Github to authenticate
users on our behalf.</p>

<p>To register a new application, follow these steps:</p>

<ol>
  <li>Go to <a href="https://www.github.com">www.github.com</a> and login.</li>
  <li>Once logged in, click here to access your <a href="https://github.com/settings/developers">Developer settings</a>, check to see that you‚Äôre in the <code class="highlighter-rouge">OAuth Apps</code> section.</li>
  <li>Click on <code class="highlighter-rouge">New OAuth App</code>.</li>
  <li>Fill in <code class="highlighter-rouge">Application name</code> with any name you want.</li>
  <li>Fill in <code class="highlighter-rouge">Homepage URL</code> with: <code class="highlighter-rouge">http://localhost:3000</code>.</li>
  <li>Fill in <code class="highlighter-rouge">Application Description</code> with whatever you like.</li>
  <li>Fill in <code class="highlighter-rouge">Authorization callback URL</code> with
<code class="highlighter-rouge">http://localhost:3000/auth/github/callback</code> <strong>(Make sure you use <code class="highlighter-rouge">http</code> and not
<code class="highlighter-rouge">https</code>)</strong></li>
  <li>Click on <code class="highlighter-rouge">Register application</code></li>
  <li>The page should refresh and show you your application information. Save this
page so we can reference the <code class="highlighter-rouge">client_id</code> and <code class="highlighter-rouge">client_secret</code>.</li>
</ol>

<h3 id="step-2---creating-a-new-rails-app">Step 2 - Creating a new Rails app</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">rails</span> <span class="n">_5</span><span class="o">.</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">3</span><span class="n">_</span> <span class="n">new</span> <span class="n">oauth_workshop</span> <span class="o">-</span><span class="no">T</span> <span class="o">-</span><span class="n">d</span> <span class="n">postgresql</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">spring</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">turbolinks</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">oauth_workshop</span>
<span class="err">$</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:create</span>
</code></pre></div></div>

<p>Let‚Äôs add the gems we will need. We want to use Faraday for sending our HTTP
requests to Github, and we also want to use Pry for debugging.</p>

<p><strong>Gemfile</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'faraday'</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'pry'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Bundle!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle <span class="nb">install</span>
</code></pre></div></div>

<h3 id="step-3---authenticating-user-on-github">Step 3 - Authenticating user on Github</h3>

<p>Our users will start this entire process by visiting our page. The first thing that we need for them is a landing page of some sort that will give them the opportunity to log in with GitHub.</p>

<p>Let‚Äôs start by creating a route for our users to visit.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="s2">"home#index"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that assumes that we have a <code class="highlighter-rouge">HomeController</code> with an <code class="highlighter-rouge">index</code> action on it. Let‚Äôs create that now.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/home_controller.rb</span>
<span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With that controller action in place we now need a view to display. Start by creating the directory structure/file.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>app/views/home
<span class="nv">$ </span><span class="nb">touch </span>app/views/home/index.html.erb
</code></pre></div></div>

<p>In your newly created view, let‚Äôs start off with the following.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Welcome!<span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<p>Great! Let‚Äôs visit that page to see if what we have so far is linking up correctly. Fire up your server with <code class="highlighter-rouge">rails s</code> and visit <code class="highlighter-rouge">http://localhost:3000</code>. You should see a page that just says <code class="highlighter-rouge">Welcome!</code></p>

<p>Now, the very first step in getting our user authenticated with GitHub is to have them visit GitHub! We can do this by adding a link to GitHub from our homepage.</p>

<p>But how will GitHub know what to do with our user once they get there? We don‚Äôt want to send them to just the GitHub homepage. We want to send them to a portal that GitHub has created for the specific purpose of authenticating users for other applications. Additionally, when we send them to GitHub we need to tell them who sent our user there in the first place.</p>

<p>It‚Äôs almost as though we are sending our users over to a friend‚Äôs house and telling them ‚ÄòTell them Jessica sent you,‚Äô except in this case we‚Äôre going to replace <code class="highlighter-rouge">Jessica</code> with our <code class="highlighter-rouge">client_id</code>. More information about this handshake process is available in the <a href="https://developer.github.com/apps/building-oauth-apps/authorization-options-for-oauth-apps/">GitHub documentation</a>.</p>

<p>GitHub specifies that the link we use to start this process is <code class="highlighter-rouge">https://github.com/login/oauth/authorize</code>. We‚Äôll provide our <code class="highlighter-rouge">client_id</code> as a query parameter in the URL. For GitHub specifically, also need to give some additional information about the kind of information we want to have access to. GitHub calls these <a href="https://developer.github.com/v3/oauth/#scope">scopes</a>.</p>

<p>Altogether our link will look something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/login/oauth/authorize?client_id=YOUR_CLIENT_ID&amp;scope=repo
</code></pre></div></div>

<p>Adding that to our <code class="highlighter-rouge">index.html.erb</code> gives us the following:</p>

<p><strong>app/views/home/index.html.erb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">Welcome</span><span class="o">!&lt;</span><span class="sr">/h1&gt;

&lt;%= link_to "Login",
"https:/</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">login</span><span class="o">/</span><span class="n">oauth</span><span class="o">/</span><span class="n">authorize?client_id</span><span class="o">=</span><span class="no">YOUR_CLIENT_ID</span><span class="o">&amp;</span><span class="n">scope</span><span class="o">=</span><span class="n">repo</span><span class="s2">" %&gt;
</span></code></pre></div></div>

<p>Spin up that server, visit localhost in an incognito window (this prevents us from having to constantly clear our cookies throughout the tutorial), and let‚Äôs visit click on <code class="highlighter-rouge">Login</code> (Make sure you are signed out of Github)</p>

<p>You should see that you have been redirected to the Github site, and have been
asked to login. Enter your credentials, and now you should see that Github is
asking you to authorize the application (the application name is whatever you
set it as in your Github settings).</p>

<p>Click on <code class="highlighter-rouge">Authorize application</code></p>

<p>You should now see an error <code class="highlighter-rouge">No route matches [GET] "/auth/github/callback"</code>
If you look at the url, you can see that it
matches the callback url we specified in our app settings on Github. You can
also see that there is a code in the params. We don‚Äôt have this route in our
app, so let‚Äôs set that up.</p>

<p><strong>config/routes.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="s2">"home#index"</span>

  <span class="n">get</span> <span class="s1">'/auth/github/callback'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'sessions#create'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now that we have a route, let‚Äôs also get our controller and action setup.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">touch </span>app/controllers/sessions_controller.rb
</code></pre></div></div>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="step-4---get-our-authentication-token">Step 4 - Get our authentication token</h3>

<p>So far we have mostly proved that we are who we said we are
by logging into Github. But Github wants one more check, and to do this we need
to send back the code they gave us when we logged in by sending a POST request
to <code class="highlighter-rouge">https://github.com/oauth/access_token</code>. Let‚Äôs take a look at the info we are
getting back in our sessions#create method.</p>

<p>Add a <code class="highlighter-rouge">binding.pry</code> within our sessions#create method.</p>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let‚Äôs try that callback again. Refresh our page with the routing error and we should be stopped by our debugger.</p>

<p>In your pry session, type in <code class="highlighter-rouge">params</code> and you should see something like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>1] pry<span class="o">(</span><span class="c">#&lt;SessionsController&gt;)&gt; params</span>
<span class="o">=&gt;</span> &lt;ActionController::Parameters <span class="o">{</span><span class="s2">"code"</span><span class="o">=&gt;</span><span class="s2">"430c3d0bd82c664b9652"</span>, <span class="s2">"controller"</span><span class="o">=&gt;</span><span class="s2">"sessions"</span>, <span class="s2">"action"</span><span class="o">=&gt;</span><span class="s2">"create"</span><span class="o">}</span> permitted: <span class="nb">false</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>We can see that GitHub is giving us the code (Your code should be different).</p>

<p>Let‚Äôs use this code and send a POST request to Github. Remember that according to <a href="https://docs.github.com/en/developers/apps/authorizing-oauth-apps#redirect-urls">the GitHub docs</a> we need to also include our <code class="highlighter-rouge">client_id</code> and the <code class="highlighter-rouge">client_secret</code>.</p>

<p>Let‚Äôs also add a <code class="highlighter-rouge">binding.pry</code> to the end of our method so we can see what we are getting back</p>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">client_id</span> <span class="o">=</span> <span class="no">YOUR_CLIENT_ID</span>
  <span class="n">client_secret</span> <span class="o">=</span> <span class="no">YOUR_CLIENT_SECRET</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:code</span><span class="p">]</span>

  <span class="n">conn</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">url: </span><span class="s1">'https://github.com'</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span><span class="s1">'Accept'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">})</span>

  <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="s1">'/login/oauth/access_token'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">req</span><span class="o">|</span>
    <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'code'</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_id</span>
    <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'client_secret'</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_secret</span>
  <span class="k">end</span>

  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let‚Äôs now run through the logging in process again, and then look at pry to see
what kind of response we are getting back. Again, logout of GitHub and clear
your cookies if you aren‚Äôt using an incognito window.</p>

<p>Within pry, type in <code class="highlighter-rouge">response</code> and we should see the whole response.
What we actually want is the response body, so let‚Äôs type in <code class="highlighter-rouge">response.body</code> and
we get the access token we need in order to hit the API and get back user data.
Notice that we do need to parse out that token. Let‚Äôs take a trip to Rubyville.</p>

<p>While we only really want the token, let‚Äôs go ahead and parse this response to look like the hash it feels like it should be. We‚Äôll also go ahead and pull that token out at the end.</p>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="c1"># everything we had above, plus the following:</span>

  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
  <span class="n">access_token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="ss">:access_token</span><span class="p">]</span>

  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now that we have the token, we can use this token to get user data from github
and create a user in our database. If we look at the docs again, we can see that
we can send a GET request to <code class="highlighter-rouge">https://api.github.com/user?access_token</code> with
<code class="highlighter-rouge">access_token</code> as a param.</p>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="c1"># everything we had above, plus the following:</span>

  <span class="c1"># note we're hitting a different domain, api.github.com</span>
  <span class="c1"># so we're going to rebuild 'conn'</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="ss">url: </span><span class="s1">'https://api.github.com'</span><span class="p">,</span>
    <span class="ss">headers: </span><span class="p">{</span>
        <span class="s1">'Authorization'</span><span class="p">:</span> <span class="s2">"token </span><span class="si">#{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">"</span>
    <span class="p">}</span>
  <span class="p">)</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/user'</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>

  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let‚Äôs take a look at the response we are getting!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>3] pry<span class="o">(</span><span class="c">#&lt;SessionsController&gt;)&gt; data</span>
</code></pre></div></div>

<p>You should now see something like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">data</span><span class="o">=&gt;</span> <span class="o">{</span>
  :login<span class="o">=&gt;</span><span class="s2">"iandouglas"</span>,
  :id<span class="o">=&gt;</span>168030,
  :node_id<span class="o">=&gt;</span><span class="s2">"MDQ6VXNlcjE2ODAzMA=="</span>,
  :avatar_url<span class="o">=&gt;</span><span class="s2">"https://avatars0.githubusercontent.com/u/168030?v=4"</span>,
  :gravatar_id<span class="o">=&gt;</span><span class="s2">""</span>,
  :url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas"</span>,
  :html_url<span class="o">=&gt;</span><span class="s2">"https://github.com/iandouglas"</span>,
  :followers_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/followers"</span>,
  :following_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/following{/other_user}"</span>,
  :gists_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/gists{/gist_id}"</span>,
  :starred_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/starred{/owner}{/repo}"</span>,
  :subscriptions_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/subscriptions"</span>,
  :organizations_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/orgs"</span>,
  :repos_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/repos"</span>,
  :events_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/events{/privacy}"</span>,
  :received_events_url<span class="o">=&gt;</span><span class="s2">"https://api.github.com/users/iandouglas/received_events"</span>,
  :type<span class="o">=&gt;</span><span class="s2">"User"</span>,
  :site_admin<span class="o">=&gt;</span><span class="nb">false</span>,
  :name<span class="o">=&gt;</span><span class="s2">"ian douglas"</span>,
  :company<span class="o">=&gt;</span><span class="s2">"iandouglas.com"</span>,
  :blog<span class="o">=&gt;</span><span class="s2">"http://iandouglas.com"</span>,
  :location<span class="o">=&gt;</span><span class="s2">"Denver, CO"</span>,
  :email<span class="o">=&gt;</span>nil,
  :hireable<span class="o">=&gt;</span>nil,
  :bio<span class="o">=&gt;</span><span class="s2">"Sr Instructor @turingschool, open-source advocate, maker/teacher/trainer/learner"</span>, :twitter_username<span class="o">=&gt;</span>nil,
  :public_repos<span class="o">=&gt;</span>118,
  :public_gists<span class="o">=&gt;</span>21,
  :followers<span class="o">=&gt;</span>139,
  :following<span class="o">=&gt;</span>5,
  :created_at<span class="o">=&gt;</span><span class="s2">"2009-12-15T18:48:12Z"</span>,
  :updated_at<span class="o">=&gt;</span><span class="s2">"2020-08-19T05:51:56Z"</span>
<span class="o">}</span>
<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;SessionsController&gt;)&gt;</span>
</code></pre></div></div>

<p>Update the code:</p>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">client_id</span> <span class="o">=</span> <span class="no">YOUR_CLIENT_ID</span>
  <span class="n">client_secret</span> <span class="o">=</span> <span class="no">YOUR_CLIENT_SECRET</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:code</span><span class="p">]</span>

  <span class="n">conn</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">url: </span><span class="s1">'https://github.com'</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span><span class="s1">'Accept'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">})</span>

  <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="s1">'/login/oauth/access_token'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">req</span><span class="o">|</span>
    <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'code'</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_id</span>
    <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'client_secret'</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_secret</span>
  <span class="k">end</span>

  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
  <span class="n">access_token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="ss">:access_token</span><span class="p">]</span>

  <span class="c1"># note we're hitting a different domain, api.github.com</span>
  <span class="c1"># so we're going to rebuild 'conn'</span>
  <span class="n">conn</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="ss">url: </span><span class="s1">'https://api.github.com'</span><span class="p">,</span>
    <span class="ss">headers: </span><span class="p">{</span>
        <span class="s1">'Authorization'</span><span class="p">:</span> <span class="s2">"token </span><span class="si">#{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">"</span>
    <span class="p">}</span>
  <span class="p">)</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/user'</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now we have a hash of the user‚Äôs data, and we can now create a user in our
database so we can use their information every time they log in. We want to think about
the data that we are always going to need when they login. We are going to want to keep
THREE pieces of data.</p>

<ol>
  <li>The <code class="highlighter-rouge">id</code> that is given to us in the response. This way we have something
unique (from GitHub) we can check against to confirm we are getting the correct user.</li>
  <li>The <code class="highlighter-rouge">access token</code> we received. We will need this in order to hit the api
endpoints for the user.</li>
  <li>The <code class="highlighter-rouge">login</code> username we get in the response. We can save this as the username in our own database.</li>
</ol>

<h3 id="step-5---save-user-to-database">Step 5 - Save user to database</h3>

<p>In order to create a user, we need to create a migration.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails g model User uid username token
<span class="nv">$ </span>rake db:migrate
</code></pre></div></div>

<h5 id="wait--whats-uid">wait ‚Äì what‚Äôs ‚Äúuid‚Äù</h5>

<p>We may want to track our own user ID value from our database PLUS the unique ID value from our OAuth provider. Our ID value in the Rails model will be an integer, but the unique ID we get from our OAuth provider may NOT be an integer. (it‚Äôs a coincidence that GitHub‚Äôs ID is also an integer)</p>

<h5 id="next">Next:</h5>

<p>Now that we have a <code class="highlighter-rouge">User</code> model, we want to find or create our user. Let‚Äôs find the user
by their id that comes through in the auth hash. If we don‚Äôt find the user in the db,
we can create the user. We can do this with the ActiveRecord method <code class="highlighter-rouge">find_or_create_by</code>.
Once we find the user, we save their data into the db.</p>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="c1"># everything we had above, plus the following:</span>

  <span class="n">user</span>          <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">uid: </span><span class="n">data</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="ss">:login</span><span class="p">]</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">uid</span>      <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">token</span>    <span class="o">=</span> <span class="n">access_token</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">save</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let‚Äôs login again so we can hit our pry. Type in <code class="highlighter-rouge">user</code>. We saved our first user! Huzzah! Now let‚Äôs implement a current user in our application controller so
that we have access to this user in our views. First, let‚Äôs save the user‚Äôs <code class="highlighter-rouge">id</code> to a session variable.</p>

<p><strong>app/controllers/sessions_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="c1"># everything we had above, plus the following:</span>

  <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Great! We have a User, we‚Äôve stored that user‚Äôs id in our session, and we‚Äôre just about ready to show them the next page. Let‚Äôs redirect our now logged in user to their dashboard.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="c1"># everything we had above, plus the following:</span>

  <span class="n">redirect_to</span> <span class="n">dashboard_path</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That will give us an error that our dashboard path doesn‚Äôt exist. Let‚Äôs add it to our routes file.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="s1">'home#index'</span>

  <span class="n">get</span> <span class="s1">'/auth/github/callback'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'sessions#create'</span>
  <span class="n">get</span> <span class="s1">'/dashboard'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'dashboard#show'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>New error: we need a DashboardController to handle that. Let‚Äôs make one of those.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/dashboard_controller.rb</span>
<span class="k">class</span> <span class="nc">DashboardController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>New error: missing a template. Let‚Äôs make one!</p>

<p><strong>app/views/dashboard/show.html.erb</strong></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Welcome, <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">current_user.username</span> <span class="err">%</span><span class="nt">&gt;&lt;/h1&gt;</span>
</code></pre></div></div>

<p>Notice that I‚Äôm using <code class="highlighter-rouge">current_user</code> here. We don‚Äôt actually have a <code class="highlighter-rouge">current_user</code> method set up coming from our DashboardController or our ApplicationController. That doesn‚Äôt bother me. I‚Äôm writing this view the way that I <em>want</em> it to work, in a way that‚Äôs familiar to me. I have enough faith in myself as a dev that I can go back and make it work. We‚Äôll do that next.</p>

<p>This is something that we might want to have access to at different places in our app. Let‚Äôs go ahead and create the method in our ApplicationController.</p>

<p><strong>app/controllers/application_controller.rb</strong></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with: :exception</span>

  <span class="n">helper_method</span> <span class="ss">:current_user</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Let‚Äôs log back in to our app. We should now see that we have landed on the dashboard page. HOORAY!</p>

<h3 id="step-6-optional---hitting-the-api-to-access-user-data">STEP 6 (OPTIONAL) - Hitting the API to access user data</h3>

<p>Let‚Äôs add another <code class="highlighter-rouge">binding.pry</code> in our sessions#create and see how we can use the token to access
the user‚Äôs repos.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="c1"># everything we had up until we saved the session</span>

  <span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span>

  <span class="c1"># add a binding pry BEFORE our redirect:</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>

  <span class="n">redirect_to</span> <span class="n">dashboard_path</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Log back in to your app so we can hit the pry. Let‚Äôs start by sending a GET request to the endpoint <code class="highlighter-rouge">/user/repos</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] pry(#&lt;SessionsController&gt;)&gt; response = Faraday.get("https://api.github.com/user/repos")
</code></pre></div></div>

<p>If you look at the <code class="highlighter-rouge">response.body</code>, you can see that we get a message telling us that we require authentication. We need to
send the access_token with our request. So it‚Äôs a good thing we saved that token to our user. Let‚Äôs try sending the request again
but this time let‚Äôs include the <code class="highlighter-rouge">access_token</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;SessionsController&gt;)&gt; response = Faraday.get("https://api.github.com/user/repos", {}, {"Authorization": "token #{user.token}" })</span>
<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;SessionsController&gt;)&gt; JSON.parse(response.body, symbolize_names: true)</span>
</code></pre></div></div>

<p>Now you should be able to see an array of hashes of your repo data.</p>

<h2 id="workshop---implement-twitter-oauth-with-the-twitter-gem">WORKSHOP - Implement Twitter OAuth with the Twitter gem</h2>

<p>Now that you understand how oauth works behind the scenes, implementing oauth with a gem should seem a lot easier.
See if you can implement oauth in a rails app with the going through this <a href="https://github.com/turingschool/lesson_plans/blob/master/ruby_03-professional_rails_applications/archive/getting_started_with_oauth.md#user-content-workshop----implementing-oauth-with-twitter">tutorial</a>.</p>

<p><a href="https://github.com/arunagw/omniauth-twitter">Twitter gem</a></p>

<h2 id="resources-for-further-study">Resources for Further Study</h2>

<ul>
  <li><a href="http://en.wikipedia.org/wiki/OAuth">OAuth</a> on Wikipedia</li>
  <li><a href="http://lifehacker.com/5918086/understanding-oauth-what-happens-when-you-log-into-a-site-with-google-twitter-or-facebook">Understanding OAuth</a> on LifeHacker</li>
  <li><a href="https://github.com/intridea/omniauth">OmniAuth</a> for integration in Ruby web apps</li>
  <li><a href="http://puu.sh/2pJ4y">Oauth 1.0 Diagram (from MashApe‚Äôs oauth bible)</a></li>
  <li><a href="http://oauthbible.com/">Oauth Bible</a> - lots of in-depth info about different oauth versions and components</li>
  <li><a href="http://edgecasesshow.com/036-zenos-paradox-of-authentication.html">Edge Cases Podcast #36</a> - Good in-depth discussion of the evolution of Oauth and the pros and cons of using it.</li>
  <li><a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a> ‚Äì Oauth provider gem</li>
  <li>OmniAuth core API documentation: https://github.com/intridea/omniauth</li>
  <li>OmniAuth wiki: https://github.com/intridea/omniauth/wiki</li>
  <li>A Devise and OmniAuth powered Single-Sign-On implementation: https://github.com/joshsoftware/sso-devise-omniauth-provider</li>
  <li><a href="http://railscasts.com/episodes/235-devise-and-omniauth-revised">RailsCast on combining Devise and OmniAuth</a></li>
</ul>
:ET