I"ÀH<p>This lesson was last updated to work with Rails 5.2.0 and Ruby 2.4.1.</p>

<h2 id="warmup">WarmUp</h2>

<ul>
  <li>Let‚Äôs define email.</li>
  <li>What do emails have to do with web apps?</li>
  <li>What are examples of things we can do with email in our apps?</li>
</ul>

<h2 id="sending-email-with-sendgrid">Sending Email with SendGrid</h2>

<p>We‚Äôll explore sending email in Rails by building a project that requires this functionality. By the end you should understand:</p>

<ul>
  <li>How to use ActionMailer</li>
  <li>How to setup  SendGrid</li>
  <li>Send email locally using Mailcatcher</li>
</ul>

<h3 id="youve-changed">You‚Äôve Changed</h3>

<p>Sometimes in life, people change. Like a frog boiled slowly in a pot of
water, they may not notice. It‚Äôs our job as friends to let people know:
‚ÄúYou‚Äôve Changed‚Äù.</p>

<p>However in-person communication is sometimes a bit dicey. Let‚Äôs build an
app that lets us do this electronically via email.</p>

<p>What we‚Äôd like our app to do:</p>

<ol>
  <li>Allow us to sign up / log in</li>
  <li>Allow us to enter a friend‚Äôs email address</li>
  <li>Send that friend a passive-aggressive email notifying them that
‚ÄúYou‚Äôve changed‚Äù.</li>
</ol>

<h2 id="researching-with-the-docs">Researching with the Docs</h2>
<ul>
  <li><a href="http://whatismyipaddress.com/smtp">What is SMTP?</a></li>
  <li><a href="http://guides.rubyonrails.org/action_mailer_basics.html">Action Mailer</a></li>
</ul>

<h3 id="smtp">SMTP</h3>

<ul>
  <li>Simple Mail Transfer Protocol</li>
  <li>Protocol used only to send emails.</li>
  <li>Often limited. Comcast customers cap at 1,000 outgoing emails a day</li>
  <li>Gmail caps at 150 a day using a client, and 500 through the web.</li>
  <li>Why be there caps?</li>
  <li>What if you get identified as a bad person?</li>
</ul>

<h3 id="action-mailer">Action Mailer</h3>

<ul>
  <li>NOT a super hero.</li>
  <li>Kind of works like a controller but for emails. Stay with me, this will make
sense later.</li>
  <li>If we have a controller, we have‚Ä¶ views‚Ä¶ but not views‚Ä¶ emails. Views ARE the emails when it comes to Action Mailer. Just go with me on this one.</li>
</ul>

<h3 id="mailcatcher">Mailcatcher</h3>

<ul>
  <li>Mailcatcher is a local SMTP server that you run on your computer.</li>
  <li>Only it also receives email.</li>
  <li>It lets us test locally that emails are being sent the way we want them to.</li>
  <li>It sends emails locally but they never leave.</li>
  <li>We don‚Äôt use mailcatcher to actually send emails, we will be using a third party service to do this - SendGrid.</li>
</ul>

<h2 id="sending-email-locally-with-mailcatcher">Sending Email locally with Mailcatcher</h2>

<h3 id="getting-started">Getting Started</h3>

<p>For this tutorial, we are going to setup our emails to ‚Äúsend‚Äù through mailcatcher locally. And in production, the emails will actually send through Sendgrid. If you want to setup an account with Sendgrid in order to send emails both locally and in production, you can set up an account with them. Keep in mind that Sendgrid will provision your account at first so it might take some time to get the account set up. You should sign up for the free account.</p>

<p>First things first, go ahead and clone down the repo.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/turingschool-examples/youve_changed_v2.git youve_changed
<span class="nv">$ </span><span class="nb">cd </span>youve_changed
<span class="nv">$ </span>bundle
<span class="nv">$ </span>rake db:<span class="o">{</span>create,migrate<span class="o">}</span>
</code></pre></div></div>

<h3 id="rails-setup">Rails Setup</h3>
<p>Run your server to see what we‚Äôve already got in our repo</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails s
</code></pre></div></div>

<p>So you can create an account and when you‚Äôre logged in we have a form with a button that says ,‚ÄùTell them.‚Äù</p>

<p>Where does that button take us? Welp, there‚Äôs no route for that, so we have to go make one.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">post</span> <span class="s1">'/notification'</span> <span class="o">=&gt;</span> <span class="s1">'notification#create'</span>
</code></pre></div></div>

<p>So at this point we‚Äôve got a route which will hit a notification controller, and we need to make a notificaion controller. Then the create action here will call our mailer. And the hip bone is connected to the leg bone, etc etc.</p>

<h3 id="create-yonder-mailer">Create Yonder Mailer</h3>

<p>Lets take a quick look at the <a href="http://guides.rubyonrails.org/action_mailer_basics.html">documentation</a></p>

<p>Looks like our steps are as follows:</p>

<ul>
  <li>Generate a mailer</li>
  <li>Edit the mailer</li>
  <li>Edit the mailer view</li>
</ul>

<p>At this point we are going to kind of work backwards from our pseudo view in a similar vein to how we did things with our consuming an API.</p>

<p>Let‚Äôs use the generator to set up our mailer, because it‚Äôll create a bunch of files for us.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g mailer FriendNotifier
</code></pre></div></div>

<p>Let‚Äôs look at two files in particular. When you generated your mailer, two layouts were added to app/views/layouts - mailer.html.erb and mailer.text.erb.  Take a look at these files, what are they doing? Why do we get both an HTML and txt layout?</p>

<p>We‚Äôre going to say that the email is going to inform them, so, in app/views/friend_notifier create two files, inform.html.erb and inform.text.erb</p>

<p>Depending on the person‚Äôs email client you‚Äôre sending the email to, it will render either the plain text or the html view. We don‚Äôt have control over that, so we‚Äôll make them have the same content.</p>

<p>We are going to make the decision here that the recipient should know who wants them to change. For extra fun, you could probably bring in the Faker gem.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># inform.html.erb and inform.text.erb</span>

<span class="no">Your</span> <span class="s2">"friend"</span> <span class="o">&lt;</span><span class="sx">%= @user.name.capitalize %&gt; wanted to let you know that you've changed. Tell someone else that they've changed. It's your duty.
</span></code></pre></div></div>

<p>Let‚Äôs also change the default address the email gets sent from:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/mailers/application_mailer.rb</span>

<span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s2">"no-reply@youvechanged.io"</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>So now we have to edit our mailer. We are using the instance variable <code class="highlighter-rouge">@user</code> in our view, so we need to send it a user and what other information do we need for this mailer to work? The email address we are sending it to.</p>

<p>And this mailer should get two things, the email address of where we are sending it and info about the person sending. We are calling the method inform to match what we decided the name of the view was, <code class="highlighter-rouge">inform</code>.</p>

<p>If we look at the ActionMail documentation, we see that there‚Äôs a mail method, and it takes a hash as an argument, with two keys of note, to and subject.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mailers/friend_notifier.rb</span>

<span class="k">class</span> <span class="nc">FriendNotifierMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="k">def</span> <span class="nf">inform</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">friend_contact</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">friend_contact</span><span class="p">,</span> <span class="ss">subject: </span><span class="s2">"</span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> says you've changed."</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>So now we have to call the mailer. Documentation is available <a href="http://guides.rubyonrails.org/action_mailer_basics.html#calling-the-mailer">here</a></p>

<p>As you can see, you have the flexibility to send in almost anything as a hash with all of these assorted options, but we don‚Äôt <em>have</em> to use them. We‚Äôve created a method in our mailer that just takes two arguments, and we can use that without too much trouble.</p>

<p>What I do want to draw your attention to is the <code class="highlighter-rouge">.deliver_now</code> and <code class="highlighter-rouge">.deliver_later</code> Essentially they use ActiveJob to hand off the sending of mail and not make the user wait in the middle of our request and response cycle to have the mail sent before responding. We‚Äôre gonna talk about that later.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># app/controllers/notification_controller.rb</span>

<span class="k">class</span> <span class="nc">NotificationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="no">FriendNotifierMailer</span><span class="p">.</span><span class="nf">inform</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">deliver_now</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Successfully told your friend that they've changed."</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="configuring-mailcatcher">Configuring Mailcatcher</h3>

<p>Take a moment to see what you can figure out from the <a href="https://mailcatcher.me/">MailCatcher</a> docs.</p>

<p>Mailcatcher allows you to test sending email. It is a simple SMTP server that receives emails, and it gives you a web interface that allows you to inspect outgoing emails. Mailcatcher does not allow the emails to actually go out, and so you are able to test that emails send, without having to worry about that email being flooded with emails.</p>

<p>Let‚Äôs get it set up.</p>

<p>You want to install the Mailcatcher gem, but you do not want to add it to your gemfile in order to prevent conflicts with your applications gems.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gem <span class="nb">install </span>mailcatcher
</code></pre></div></div>

<p>Now let‚Äôs setup our development config to send the emails to the mailcatcher port. Add the following code to your environments/development.rb file.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># environments/development.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:address</span> <span class="o">=&gt;</span> <span class="s2">"localhost"</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">1025</span> <span class="p">}</span>
</code></pre></div></div>

<p>The mail is sent through port 1025, but in order to view the mailcatcher interface we want to visit port 1080. To start up mailcatcher:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mailcatcher
</code></pre></div></div>

<p>Now open up http://localhost:1080 and you should see the interface for where emails are sent. Now let‚Äôs test to see emails come through.</p>

<p>If you open up the app in a browser locally, and run through the steps to send an email, you should see the email come through on mailcatcher.</p>

<h2 id="setting-up-sendgrid-email-through-a-heroku-addon">Setting up Sendgrid email through a Heroku addon</h2>

<p>Heroku makes it really easy to setup Sendgrid through an add on. In order to do this, you will first need to push your app to heroku.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>heroku create
<span class="nv">$ </span>git push heroku master
<span class="nv">$ </span>heroku run rake db:migrate
</code></pre></div></div>

<p>Now, let‚Äôs walk through the <a href="https://devcenter.heroku.com/articles/sendgrid#actionmailer">SendGrid/Heroku Docs</a>. Notice this link takes us to the <code class="highlighter-rouge">ActionMailer</code> section. You can send email using the SendGrid Ruby gem but we‚Äôll be using <code class="highlighter-rouge">ActionMailer</code> in combination with the gem. Make sure the documentation you are referencing is specific to <code class="highlighter-rouge">ActionMailer</code>.</p>

<p>Some stuff to copy and paste:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#application.rb</span>

<span class="k">module</span> <span class="nn">YouveChangedV2</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>

    <span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">address:              </span><span class="s1">'smtp.sendgrid.net'</span><span class="p">,</span>
      <span class="ss">port:                 </span><span class="s1">'587'</span><span class="p">,</span>
      <span class="ss">domain:               </span><span class="s1">'example.com'</span><span class="p">,</span>
      <span class="ss">user_name:            </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"SENDGRID_USERNAME"</span><span class="p">],</span>
      <span class="ss">password:             </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"SENDGRID_PASSWORD"</span><span class="p">],</span>
      <span class="ss">authentication:       </span><span class="s1">'plain'</span><span class="p">,</span>
      <span class="ss">enable_starttls_auto: </span><span class="kp">true</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="dont-forget-figaro">Don‚Äôt Forget Figaro</h3>

<p>Let‚Äôs setup figaro so that we can add our username and password we got above in our command line to our application.yml file.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>

<span class="n">gem</span> <span class="s1">'figaro'</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle
<span class="nv">$ </span>bundle <span class="nb">exec </span>figaro <span class="nb">install</span>
</code></pre></div></div>

<p>This creates an application.yml file and adds it to your .gitignore
For now, let‚Äôs put our Sendgrid username and password into the newly created application.yml file.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.yml</span>

<span class="no">SENDGRID_USERNAME</span><span class="p">:</span> <span class="n">abcdefghijklmnop</span>
<span class="no">SENDGRID_PASSWORD</span><span class="p">:</span> <span class="mi">123456789</span>
</code></pre></div></div>

<p>And remember, don‚Äôt add the application.yml to your commits! We never push up our keys to Github.</p>

<p>Push up your changes to heroku:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"email changes"</span>
<span class="nv">$ </span>git push heroku master
</code></pre></div></div>

<p>Now that this is all setup, go out to your production app, send an email to yourself and watch it appear in your inbox (Be patient, it takes a couple minutes). Huzzah!</p>

<h3 id="materials">Materials</h3>

<ul>
  <li><a href="https://github.com/turingschool-examples/youve_changed"> Repo </a></li>
  <li><a href="https://www.dropbox.com/s/ev7tya328sv9jyh/Turing%20-%20Sending%20Email.key?dl=0"> Slides </a></li>
  <li><a href="https://www.dropbox.com/s/p496zd4xthyrnt6/Turing%20-%20Sending%20Email%20%28Notes%29.pages?dl=0"> Notes </a></li>
  <li><a href="https://devcenter.heroku.com/articles/sendgrid#provisioning-the-add-on">Heroku Docs for Sendgrid Addon</a></li>
</ul>
:ET