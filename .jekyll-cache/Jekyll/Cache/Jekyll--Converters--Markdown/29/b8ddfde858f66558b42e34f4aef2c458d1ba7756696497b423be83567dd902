I"à<h1 id="cron-and-rails-runner">Cron and Rails Runner</h1>
<h3 id="setup">Setup</h3>
<p>Clone the <a href="https://github.com/turingschool-examples/cron_and_rails_runner">sample Rails app</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bundle
$ git checkout 24cfb78
$ rake db:migrate db:seed
$ rails s
</code></pre></div></div>

<h3 id="our-sample-app">Our Sample App</h3>

<p>Visit http://localhost:3000/tasks to view a table of tasks.
You should see a list of 10 tasks.</p>

<p>If you look at <code class="highlighter-rouge">task.rb</code> you will see a simple method, <code class="highlighter-rouge">.cleanup_completed</code>. This deletes completed tasks from the database.</p>

<p>Go ahead and fire up a rails console and run this method.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rails c
$ Task.cleanup_completed
</code></pre></div></div>

<p>This should delete 3 rows from the database. Refresh the browser and you should see only incomplete tasks.</p>

<h3 id="meet-rails-runner">Meet <code class="highlighter-rouge">rails runner</code></h3>

<p><code class="highlighter-rouge">rails runner</code> gives us the ability to run methods from the command line.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/rails runner "Task.delete_all"
</code></pre></div></div>

<p>If you refresh your browser there should be no tasks present.</p>

<p>Re-populate the list by running <code class="highlighter-rouge">rake db:seed</code>. Refresh your browser and confirm you have 10 tasks.</p>

<p>Use <code class="highlighter-rouge">rails runner</code> to run the <code class="highlighter-rouge">.cleanup_completed</code> method and confirm  it removes all completed tasks.</p>

<h3 id="cron">Cron</h3>

<p>Make sure you have completed tasks in the database before proceeding.</p>

<p>What is <a href="http://en.wikipedia.org/wiki/Cron">cron</a>?</p>

<p>Letâ€™s create a background task to run our <code class="highlighter-rouge">.cleanup_completed</code> method by editing our crontab.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ crontab -e
</code></pre></div></div>

<p>Add the line below replacing <code class="highlighter-rouge">/PATH/TO/RAILS_DIRECTORY</code> with the path relevant to your local machine:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* * * * * /bin/bash -l -c 'cd /PATH/TO/RAILS_DIRECTORY &amp;&amp; bin/rails runner -e development '\''Task.cleanup_completed'\'''
</code></pre></div></div>

<p>Save that file and you should see the completed tasks deleted from the tasks table in the browser in about 1 minute.</p>

<h3 id="the-whenever-gem">The Whenever Gem</h3>

<p>Cron is useful, but somewhat cryptic. Wouldnâ€™t it be awesome if we could use Ruby to generate our crontab? Enter the whenever gem.</p>

<p>View the documentation on <a href="https://github.com/javan/whenever">Github</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git checkout a5a586b
</code></pre></div></div>

<p>You should have a new file: <code class="highlighter-rouge">config/schedule.rb</code>. This file was generated by the gem prior to cloning. If you run <code class="highlighter-rouge">whenever</code> you should see code that looks similar to what is currently in your crontab. One difference is that it will use the production environment by default.</p>

<p>You should also see a message that includes <code class="highlighter-rouge">your crontab file was not updated.</code>. To write to the crontab, use the <code class="highlighter-rouge">-w</code> flag.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ whenever -w
[write] crontab file written
</code></pre></div></div>

<p>If you run <code class="highlighter-rouge">crontab -e</code> you should see something similar:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 1 # Begin Whenever generated tasks for: /PATH/TO/RAILS_DIRECTORY/schedule.rb
  2 * * * * * /bin/bash -l -c 'cd /PATH/TO/RAILS_DIRECTORY &amp;&amp; bin/rails runner -e production '\''Task.cleanup_complet#
  3
  4
  5 # End Whenever generated tasks for: /PATH/TO/RAILS_DIRECTORY/schedule.rb
</code></pre></div></div>

<p>Replace <code class="highlighter-rouge">production</code> with <code class="highlighter-rouge">development</code> and save. Update the task list to include completed tasks and confirm they are being cleared out.</p>

<h3 id="things-to-try">Things to Try:</h3>

<p>Whenever allows other commands to be used in addition to <code class="highlighter-rouge">runner</code>.</p>

<ul>
  <li>
    <p>Use <code class="highlighter-rouge">command</code> in <code class="highlighter-rouge">schedule.rb</code> to remove the <code class="highlighter-rouge">development.log</code> every day. Pick a time that will allow you to see the change.</p>
  </li>
  <li>
    <p>Use <code class="highlighter-rouge">rake</code> to run a rake task within <code class="highlighter-rouge">schedule.rb</code>. Run this once a week on a specific day (Monday, Tuesday, Wednesday etc.) at a set time. Pick a day and time that will allow you to see the change.</p>
  </li>
</ul>
:ET