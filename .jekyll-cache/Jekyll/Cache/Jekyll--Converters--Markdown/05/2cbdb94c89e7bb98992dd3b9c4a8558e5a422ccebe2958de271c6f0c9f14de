I"»„<h2 id="learning-goals">Learning Goals</h2>

<ul>
  <li>Diagram database relationships.</li>
  <li>Identify the tables in a database that hold information required to complete complex queries.</li>
  <li>Generate complex ActiveRecord queries using joins, group, order, select, and merge.</li>
  <li>Use the rails dbconsole  and rails console to generate ActiveRecord queries.</li>
</ul>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://www.youtube.com/watch?v=OccKyvGvLKE&amp;t=1329s">Video</a> from a past class and the core ideas</li>
</ul>

<h2 id="objective">Objective</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Find the 5 most expensive invoices with successful transactions.
</code></pre></div></div>

<h2 id="warmup-5-mins">Warmup (5 mins)</h2>

<ul>
  <li>What tables would we need to query?</li>
  <li>What information would we need from each table?</li>
  <li>What calculations would we need to perform?</li>
  <li>What SQL would we be able to use to create a table with this information?</li>
</ul>

<h2 id="lecture">Lecture</h2>

<p><em>WARNING:</em> This lesson is most beneficial if you don‚Äôt follow along in class.</p>

<h3 id="creating-a-visual-representation">Creating a Visual Representation</h3>

<p>Have you ever attempted to build a complex ActiveRecord query by throwing spaghetti at the wall? Eventually something will stick. But there‚Äôs a better way.</p>

<p>As you start to dive into more difficult problems, problems that have many moving parts, it will become increasingly difficult to hold all of the relevant information in your head at one time. Additionally, the more complex the problem, the easier it is to slowly drift away from the goal and building the wrong thing. Starting with a clear goal and a plan will increase the likelihood of you hitting your target in a timely fashion.</p>

<p>There are official ways of diagramming SQL queries but we‚Äôre going to do something a little different. This technique isn‚Äôt an official technique so feel free to tweak or find something that works for you. If you‚Äôre interested in diving deeper into a more official strategy check out this blog post on <a href="http://www.davidclement.org/tipsntrx/tnt10.6.html">Introductory SQL Diagramming</a>.</p>

<p>We‚Äôll start by sketching out all of the columns we need including the table the column is located in.</p>

<p><img src="./images/advanced_activerecord/activerecord-query-diagram-1.jpeg" alt="relevant database tables and columns" /></p>

<p>Next up, let‚Äôs make a note about all of the things we think need to happen with each of these columns.</p>

<p><img src="./images/advanced_activerecord/activerecord-query-diagram-2.jpeg" alt="tables and columns with SQL terms and why we need them" /></p>

<h3 id="converting-to-activerecord">Converting to ActiveRecord</h3>

<p>As we work through the next section we should update the diagram if our understanding changes or if we successfully accomplish one of our goals. We can do something simple like adding a checkmark when we successfully account for each item we documented. When complete we could have a board that looks like this:</p>

<p><img src="./images/advanced_activerecord/activerecord-query-diagram-3.jpeg" alt="query plan with checkmarks" /></p>

<p>To start through this process let‚Äôs fire up a Rails console. We‚Äôll start by building our query slowly, piece by piece. Figuring out where to start is often a struggle. When we are writing a query that needs to return specific rows, invoices in this case, we should <em>start by writing our query from the Model representing those rows</em>. Sometimes, there will be a temptation to start with a join table since they are similar to a hub with spokes that branch out to the tables we need. Avoid this temptation. This will usually result in needing to make more queries than is necessary.</p>

<p>The next thing that is usually good to try is to tack on the easiest portions of the query first and read the output in the console to make sure it matches our expectations. One way to make this easier to read is to use the <code class="highlighter-rouge">.to_sql</code> method.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>irb(main)&gt; puts Invoice.joins(:invoice_items).to_sql
</code></pre></div></div>

<p>We added the <code class="highlighter-rouge">puts</code> to make it easier to read which remove escape characters.</p>

<p>The output should look something like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"invoices"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"invoices"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"invoice_items"</span> <span class="k">ON</span> <span class="nv">"invoice_items"</span><span class="p">.</span><span class="nv">"invoice_id"</span> <span class="o">=</span> <span class="nv">"invoices"</span><span class="p">.</span><span class="nv">"id"</span>
</code></pre></div></div>

<p>This looks the way we would expect. Another great tool to use as we‚Äôre trying to solve these issues is the <code class="highlighter-rouge">rails db</code> command line tool which will connect us to the database specified in our <code class="highlighter-rouge">database.yml</code> file. Let‚Äôs fire that up in another tab in our terminal. It‚Äôs worth noting that this is going to have access to any SQL commands in a similar way to using something like <code class="highlighter-rouge">psql</code> but it does not have access to the Rails environment so we won‚Äôt be able to write any Ruby. This can be a nice place to run your queries and have a table based representation of the output. This can be especially handy when you start adding aliases and things like that. If we paste that query, add on a semi-colon, and run it we should see something like this.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rales_engine_development</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="nv">"invoices"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"invoices"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"invoice_items"</span> <span class="k">ON</span> <span class="nv">"invoice_items"</span><span class="p">.</span><span class="nv">"invoice_id"</span> <span class="o">=</span> <span class="nv">"invoices"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">;</span>
  <span class="n">id</span>  <span class="o">|</span> <span class="n">customer_id</span> <span class="o">|</span> <span class="n">merchant_id</span> <span class="o">|</span> <span class="n">status</span>  <span class="o">|</span>     <span class="n">created_at</span>      <span class="o">|</span>     <span class="n">updated_at</span>
<span class="c1">------+-------------+-------------+---------+---------------------+---------------------</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">26</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
    <span class="mi">2</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>          <span class="mi">75</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">05</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">05</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">09</span>
</code></pre></div></div>

<p>It‚Äôs important to make sure we are seeing what we would expect. Why do we see multiples of the same record?</p>

<p>This looks the way that we would expect. Mark it off on the diagram. Then, let‚Äôs get to the next part of the query.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Invoice</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>Confirm the SQL looks the way it should.</li>
  <li>Mark it off on our diagram.</li>
</ol>

<p>Now we‚Äôll tack on the <code class="highlighter-rouge">where</code> method to filter by transactions that have a <code class="highlighter-rouge">result</code> of <code class="highlighter-rouge">success</code>. There‚Äôs two ways we can do this. Let‚Äôs take a look at each option.</p>

<p>Option 1. We can specify the table (<code class="highlighter-rouge">transactions</code>) and column (<code class="highlighter-rouge">result</code>) as well as the value we want to filter by (<code class="highlighter-rouge">success</code>).</p>

<h3 id="adding-where">Adding <code class="highlighter-rouge">where</code></h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Invoice</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="s2">"transactions.result = ?"</span><span class="p">,</span> <span class="s2">"success"</span><span class="p">)</span>
</code></pre></div></div>

<p>Option 2: Recall that every ActiveRecord method we chain here is executed from the perspective of starting at the Invoice model. That being the case, we can leverage the relationships set up in that model for queries like this. Before we dive in, understand that <code class="highlighter-rouge">Invoice.where(status: "shipped")</code> is the same as <code class="highlighter-rouge">Invoice.where({status: "shipped"})</code>. We don‚Äôt need the curly braces in the first example because we are only referencing one table. When traversing across multiple tables however, we will need to include the curly braces like so‚Ä¶</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Invoice</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="adding-select">Adding <code class="highlighter-rouge">select</code></h3>

<p>Our next steps get more complex since we need to run an aggregate function on the <code class="highlighter-rouge">quantity</code> and <code class="highlighter-rouge">unit_price</code> from the <code class="highlighter-rouge">invoice_items</code> table. Let‚Äôs first add the select statement to return exactly the same thing as it currently is.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Broken onto multiple lines for readability</span>
<span class="no">Invoice</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"invoices.*"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
</code></pre></div></div>

<p>And now for the aggregate function.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Broken onto multiple lines for readability</span>
<span class="no">Invoice</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
</code></pre></div></div>

<p>When we run this code we get an error. Let‚Äôs take the SQL that‚Äôs generated from calling <code class="highlighter-rouge">to_sql</code> and paste it into <code class="highlighter-rouge">rails db</code>.</p>

<p>Sure enough, we see the same-ish error:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>column "invoices.id" must appear in the GROUP BY clause or be used in an aggregate function
</code></pre></div></div>

<p>What‚Äôs happening? Well, since the result of the aggregate function, <code class="highlighter-rouge">revenue</code>, isn‚Äôt part of the table that <code class="highlighter-rouge">invoices.*</code> comes from, Postgres isn‚Äôt sure what to do with it. Telling it to group by <code class="highlighter-rouge">invoices.id</code> let‚Äôs it know how to squish things down into corresponding rows.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Invoice</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</code></pre></div></div>

<p>Again, the query is starting at <code class="highlighter-rouge">Invoice</code> so when we say <code class="highlighter-rouge">group(:id)</code> it infers that we mean <code class="highlighter-rouge">invoices.id</code>. Unfortunately, we don‚Äôt see the <code class="highlighter-rouge">revenue</code> appear in our output. But it is there as a virtual attribute. Virtual attributes get created when we have aliases in our select statements. We can access these virtual attributes the same as other columns in the table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">invoices</span> <span class="o">=</span> <span class="no">Invoice</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>

<span class="n">invoices</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">revenue</span>
<span class="c1"># =&gt; 2106777</span>
</code></pre></div></div>

<p>Noice. Sometimes it can be difficult to see whether you are getting back what you want or whether the query is doing what you think it should. This is a great time to call <code class="highlighter-rouge">to_sql</code> and paste the result into our <code class="highlighter-rouge">rails db</code> console. You should see output that looks like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">id</span>  <span class="o">|</span> <span class="n">customer_id</span> <span class="o">|</span> <span class="n">merchant_id</span> <span class="o">|</span> <span class="n">status</span>  <span class="o">|</span>     <span class="n">created_at</span>      <span class="o">|</span>     <span class="n">updated_at</span>      <span class="o">|</span> <span class="n">revenue</span>
<span class="c1">------+-------------+-------------+---------+---------------------+---------------------+---------</span>
<span class="mi">1489</span> <span class="o">|</span>         <span class="mi">289</span> <span class="o">|</span>          <span class="mi">46</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">20</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">20</span> <span class="o">|</span>  <span class="mi">944894</span>
<span class="mi">4790</span> <span class="o">|</span>         <span class="mi">988</span> <span class="o">|</span>          <span class="mi">78</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">24</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">12</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">24</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">12</span> <span class="o">|</span>   <span class="mi">48718</span>
<span class="mi">273</span>  <span class="o">|</span>          <span class="mi">59</span> <span class="o">|</span>          <span class="mi">72</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">08</span> <span class="mi">21</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">23</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">08</span> <span class="mi">21</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">23</span> <span class="o">|</span>  <span class="mi">861533</span>
<span class="mi">3936</span> <span class="o">|</span>         <span class="mi">802</span> <span class="o">|</span>          <span class="mi">94</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">20</span> <span class="mi">08</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">27</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">20</span> <span class="mi">08</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">27</span> <span class="o">|</span> <span class="mi">1085352</span>
<span class="mi">2574</span> <span class="o">|</span>         <span class="mi">521</span> <span class="o">|</span>          <span class="mi">79</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">19</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">13</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">19</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">13</span> <span class="o">|</span>  <span class="mi">975672</span>
<span class="mi">951</span>  <span class="o">|</span>         <span class="mi">184</span> <span class="o">|</span>          <span class="mi">87</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">55</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span> <span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">55</span> <span class="o">|</span> <span class="mi">1832399</span>
<span class="mi">4326</span> <span class="o">|</span>         <span class="mi">881</span> <span class="o">|</span>          <span class="mi">21</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">18</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">48</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">18</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">48</span> <span class="o">|</span>  <span class="mi">536897</span>
<span class="mi">2614</span> <span class="o">|</span>         <span class="mi">526</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">15</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">15</span> <span class="o">|</span> <span class="mi">1379489</span>
</code></pre></div></div>

<p>Notice the <code class="highlighter-rouge">revenue</code> column. Looks like we need to order these. But before we do that don‚Äôt forget to update our diagram with our progress.</p>

<h3 id="order-by-and-limit"><code class="highlighter-rouge">ORDER BY</code> and <code class="highlighter-rouge">LIMIT</code></h3>

<p>Next, we‚Äôll tack on <code class="highlighter-rouge">order</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Invoice</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"revenue DESC"</span><span class="p">)</span>
</code></pre></div></div>

<p>We can‚Äôt pass in <code class="highlighter-rouge">:revenue</code> since it‚Äôs not a column in the database and therefore we‚Äôll need to send it in as a string and tell it we want to go in descending order. Now we can tack on our <code class="highlighter-rouge">limit(5)</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Invoice</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"revenue DESC"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p>We should be good. Use <code class="highlighter-rouge">to_sql</code> in your Rails console and paste the results in your db console. You should see something like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">id</span>  <span class="o">|</span> <span class="n">customer_id</span> <span class="o">|</span> <span class="n">merchant_id</span> <span class="o">|</span> <span class="n">status</span>  <span class="o">|</span>     <span class="n">created_at</span>      <span class="o">|</span>     <span class="n">updated_at</span>      <span class="o">|</span> <span class="n">revenue</span>
<span class="c1">------+-------------+-------------+---------+---------------------+---------------------+---------</span>
<span class="mi">1560</span> <span class="o">|</span>         <span class="mi">300</span> <span class="o">|</span>          <span class="mi">10</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">02</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">24</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">02</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">24</span> <span class="o">|</span> <span class="mi">4896887</span>
<span class="mi">3394</span> <span class="o">|</span>         <span class="mi">697</span> <span class="o">|</span>          <span class="mi">64</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">57</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">57</span> <span class="o">|</span> <span class="mi">4787797</span>
<span class="mi">4377</span> <span class="o">|</span>         <span class="mi">893</span> <span class="o">|</span>          <span class="mi">68</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">18</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">51</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">18</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">51</span> <span class="o">|</span> <span class="mi">4722254</span>
<span class="mi">3584</span> <span class="o">|</span>         <span class="mi">729</span> <span class="o">|</span>          <span class="mi">15</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span> <span class="mi">11</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">08</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span> <span class="mi">11</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">08</span> <span class="o">|</span> <span class="mi">4695214</span>
<span class="mi">2711</span> <span class="o">|</span>         <span class="mi">543</span> <span class="o">|</span>          <span class="mi">14</span> <span class="o">|</span> <span class="n">shipped</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">18</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">20</span> <span class="o">|</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">18</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">20</span> <span class="o">|</span> <span class="mi">4692545</span>
</code></pre></div></div>

<p>Now we should move this to our <code class="highlighter-rouge">Invoice</code> model.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/invoice.rb</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">most_expensive</span><span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sorting</span> <span class="o">=</span> <span class="s2">"DESC"</span><span class="p">)</span>
  <span class="nb">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">transactions: </span><span class="p">{</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">})</span>
    <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"revenue </span><span class="si">#{</span><span class="n">sorting</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
</code></pre></div></div>

<p>Notice that we removed <code class="highlighter-rouge">Invoice</code> from this query. A wise person once said ‚ÄúIf you want to master Ruby, always know what <code class="highlighter-rouge">self</code> is.‚Äù We‚Äôre in a class method in <code class="highlighter-rouge">Invoice</code> which means <code class="highlighter-rouge">self</code> is <code class="highlighter-rouge">Invoice</code> so we can remove that reference. We also set two default parameters for <code class="highlighter-rouge">limit</code> and <code class="highlighter-rouge">sorting</code>. We do this to make the method more flexible and reusable.</p>

<p>Houston, we have a problem. The idea of the <code class="highlighter-rouge">Invoice</code> model tracking what it means for a transaction to be successful is a violation of SRP. We should extract <code class="highlighter-rouge">.where(transactions: {result: "success"})</code> and move it over to the <code class="highlighter-rouge">Transaction</code> model. Enter <code class="highlighter-rouge">.merge</code>‚Ä¶</p>

<h3 id="merging-scopes">Merging Scopes</h3>

<p>It‚Äôs common to want to share model logic and concepts, such as ‚Äúa successful transaction‚Äù, across multiple models. <code class="highlighter-rouge">.merge</code> allows us to pull logic from predefined methods called scopes into different portions of our codebase.</p>

<p>Let‚Äôs define a scope to capture this idea of a successful transaction in the <code class="highlighter-rouge">Transaction</code> model.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/transaction.rb</span>

<span class="k">class</span> <span class="nc">Transaction</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:successful</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That arrow looking thing is what we in the Ruby community refer to as a stabby lambda. Explaining lambdas is outside the scope of this lesson but <a href="https://www.honeybadger.io/blog/using-lambdas-in-ruby/">here‚Äôs more info</a> if you‚Äôre interested.</p>

<p>Reload your Rails console to be able to use this scope (<code class="highlighter-rouge">reload!</code>). Now run <code class="highlighter-rouge">Transaction.successful</code> and take a look at the SQL output. You should see a <code class="highlighter-rouge">WHERE</code> clause filtering by what we specified in our lambda.</p>

<p>Now let‚Äôs replace <code class="highlighter-rouge">where</code> with <code class="highlighter-rouge">merge</code> to reuse this bit of logic in <code class="highlighter-rouge">Invoice.most_expensive</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/invoice.rb</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">most_expensive</span><span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sorting</span> <span class="o">=</span> <span class="s2">"DESC"</span><span class="p">)</span>
  <span class="nb">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="no">Transaction</span><span class="p">.</span><span class="nf">successful</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"revenue </span><span class="si">#{</span><span class="n">sorting</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>One of the big advantages here is if the concept of what it means to be a successful transaction ever changes we hopefully only need to update that in one place. The original way we wrote this was vulnerable to changes not associated with this particular table or model.</p>

<p>As you can imagine, scopes are widely used on Rails projects and learning to wield their power is important. Be sure to create a <code class="highlighter-rouge">successful</code> scope on <code class="highlighter-rouge">Transaction</code> and merge it in for your other BI challenges.</p>

<p>But what if you want to have a scope applied to <em>every</em> query called on a model?</p>

<h3 id="default_scope"><code class="highlighter-rouge">default_scope</code></h3>

<p>What order does Postgres return its rows in? Read the first paragraph in this (Sorting Rows)[https://www.postgresql.org/docs/9.1/queries-order.html] documentation.</p>

<p>So then, what order will our results come back in if we call <code class="highlighter-rouge">Transaction.all</code>? What about <code class="highlighter-rouge">Transaction.limit(10)</code>?</p>

<p>Enter <code class="highlighter-rouge">default_scope</code>. This will allow us to apply a scope to every <code class="highlighter-rouge">ActiveRecord</code> query. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/transaction.rb</span>

<span class="k">class</span> <span class="nc">Transaction</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">id: :asc</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">scope</span> <span class="ss">:successful</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Reload your console and run <code class="highlighter-rouge">Transaction.all</code>. You should now see an <code class="highlighter-rouge">ORDER BY</code> clause.</p>

<h3 id="a-word-of-caution-about-default_scope">A Word of Caution about <code class="highlighter-rouge">default_scope</code></h3>

<p>Because most of our business intelligence is running analytics on only the successful transactions you might have had an idea to try something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Transaction</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Whoa! It works!? Ship it!</p>

<p>NOT SO FAST. Reload your console if you haven‚Äôt already and run <code class="highlighter-rouge">Transaction.new</code>. What‚Äôs the value of <code class="highlighter-rouge">result</code>? Surely you didn‚Äôt intend for every new transaction to be set to <code class="highlighter-rouge">success</code>. This sort of thing can cause big problems in production apps where it becomes nearly impossible to remember every model with a <code class="highlighter-rouge">default_scope</code> set. Some prefer not to use <code class="highlighter-rouge">default_scope</code> at all. My personal preference is to limit its use to ordering but even this can have some unintended consequences. Let‚Äôs change our code back to what it was.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/transaction.rb</span>

<span class="k">class</span> <span class="nc">Transaction</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">id: :asc</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">scope</span> <span class="ss">:successful</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">result: </span><span class="s2">"success"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># models/invoice.rb</span>
<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">most_expensive</span><span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sorting</span> <span class="o">=</span> <span class="s2">"DESC"</span><span class="p">)</span>
  <span class="nb">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="no">Transaction</span><span class="p">.</span><span class="nf">successful</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"revenue </span><span class="si">#{</span><span class="n">sorting</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Reload your console and call <code class="highlighter-rouge">Invoice.most_expensive</code>. You should see an error that looks something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ActiveRecord::StatementInvalid: PG::GroupingError: ERROR:  column "transactions.id" must appear in the GROUP BY clause or be used in an aggregate function
</code></pre></div></div>

<p>When we <code class="highlighter-rouge">merge</code> the <code class="highlighter-rouge">successful</code> scope in <code class="highlighter-rouge">Invoice.most_expensive</code> we now get the <code class="highlighter-rouge">default_scope</code> from the <code class="highlighter-rouge">Transaction</code> model as well. Sometimes this is good and sometimes this is bad. Right now it‚Äôs bad since our query is now attempting to order by the id from the transactions table which we haven‚Äôt selected so it blows up. The fix is simple: <code class="highlighter-rouge">unscoped</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># models/invoice.rb</span>
<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">most_expensive</span><span class="p">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sorting</span> <span class="o">=</span> <span class="s2">"DESC"</span><span class="p">)</span>
  <span class="nb">select</span><span class="p">(</span><span class="s2">"invoices.*, SUM(invoice_items.quantity * invoice_items.unit_price) AS revenue"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:invoice_items</span><span class="p">,</span> <span class="ss">:transactions</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="no">Transaction</span><span class="p">.</span><span class="nf">unscoped</span><span class="p">.</span><span class="nf">successful</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"revenue </span><span class="si">#{</span><span class="n">sorting</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">unscoped</code> removes all scopes that occur before it is called but leaves the scopes that occur after it is intact. This applies to both <code class="highlighter-rouge">default_scope</code> and <code class="highlighter-rouge">scope</code>. A tradeoff with this approach is if we were merging <code class="highlighter-rouge">Transaction.successful</code> in many queries adding <code class="highlighter-rouge">default_scope</code> might break them. That said, calling <code class="highlighter-rouge">Transaction.order(id: :asc)</code> all over our codebase might be equally bad. YMMV but be aware of the tradeoffs.</p>

<h3 id="when-you-need-to-run-raw-sql">When You Need to Run Raw SQL</h3>

<p>Sometimes it‚Äôs not possible to use <code class="highlighter-rouge">ActiveRecord</code> to build the query you need and instead you need to run raw SQL. There are two ways to do this using <code class="highlighter-rouge">ActiveRecord</code>, <code class="highlighter-rouge">find_by_sql</code> and <code class="highlighter-rouge">ActiveRecord.connection.execute</code>.</p>

<p>If you want to get an array of objects instantiated from rows in a table you can use <code class="highlighter-rouge">find_by_sql</code>. Let‚Äôs see how this works‚Ä¶</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sql</span> <span class="o">=</span> <span class="no">Invoice</span><span class="p">.</span><span class="nf">most_expensive</span><span class="p">.</span><span class="nf">to_sql</span>
<span class="c1"># =&gt; "SELECT  invoices.*, SUM(invoice_items.quantity*invoice_items.unit_price) AS revenue FROM \"invoices\" INNER JOIN \"invoice_items\" ON \"invoice_items\".\"invoice_id\" = \"invoices\".\"id\" INNER JOIN \"transactions\" ON \"transactions\".\"invoice_id\" = \"invoices\".\"id\" WHERE \"transactions\".\"result\" = 'success' GROUP BY \"invoices\".\"id\" ORDER BY revenue DESC LIMIT 5"</span>

<span class="c1"># sql is simply a string of our query</span>
<span class="n">sql</span><span class="p">.</span><span class="nf">class</span>
<span class="c1"># =&gt; String</span>

<span class="c1"># Now we run it</span>
<span class="no">Invoice</span><span class="p">.</span><span class="nf">find_by_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</code></pre></div></div>

<p>It‚Äôs worth noting that this returns as array and not an <code class="highlighter-rouge">ActiveRecord_Relation</code> object which means we cannot chain additional <code class="highlighter-rouge">ActiveRecord</code> methods on it. As a word of caution, make sure you call <code class="highlighter-rouge">find_by_sql</code> on the model that matches the table in your <code class="highlighter-rouge">SELECT</code> statement. Try this out and play around: <code class="highlighter-rouge">Merchant.find_by_sql(sql)</code>. Does it work? Which table‚Äôs attributes do you have access to?</p>

<p>One last way we can run this query is to use <code class="highlighter-rouge">ActiveRecord.connection.execute</code>. This can be useful when the data you are building doesn‚Äôt correspond to a model and might be a temporary table built in memory as a result of other filtering and calculations.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">invoices</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

<span class="n">invoices</span><span class="p">.</span><span class="nf">class</span>
<span class="c1"># =&gt; PG::Result</span>
<span class="c1"># (if you're using postgres)</span>

<span class="n">invoices</span><span class="p">.</span><span class="nf">to_a</span>
</code></pre></div></div>

<p>As you can see, we don‚Äôt get model objects. Instead we see an array of hashes. What might you do if you wanted to turn each of these hashes into an object?</p>

<p>Both <code class="highlighter-rouge">find_by_sql</code> and <code class="highlighter-rouge">ActiveRecord::Base.connection.execute</code> have their uses. If you can get by with <code class="highlighter-rouge">find_by_sql</code> that‚Äôs probably the better choice but there are times where <code class="highlighter-rouge">ActiveRecord::Base.connection.execute</code> is necessary.</p>
:ET